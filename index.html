<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#ff3b3b" />
  <title>Salesian League ‚Äî Gestione</title>
  <style>
:root{
  --bg:#0b0b0d;
  --card: rgba(255,255,255,0.06);
  --glass: rgba(255,255,255,0.06);
  --muted: rgba(255,255,255,0.75);
  --text:#ffffff;
  --accent:#ff3b3b;
  --accent-2:#ff6b6b;
  --glass-border: rgba(255,255,255,0.08);
  --glow: 0 10px 60px rgba(255,59,59,0.14);
  --radius:14px;
  --max-width:1200px;
  --btn-radius:12px;
  --btn-padding:10px 14px;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:linear-gradient(180deg,#050507 0%,#081018 65%);color:var(--text);font-family:Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;}
.wrap{min-height:100vh;display:flex;align-items:flex-start;justify-content:center;padding:18px;background:var(--bg)}
.app{width:100%;max-width:var(--max-width);display:grid;grid-template-columns:1fr;gap:14px}

/* header with logo */
header.appbar{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:8px;padding:14px;border-radius:12px;background:linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border:1px solid var(--glass-border);backdrop-filter: blur(6px);box-shadow: var(--glow)}
.league-logo{width:86px;height:86px;border-radius:12px;overflow:hidden;display:grid;place-items:center;background:linear-gradient(135deg,#ffffff10,var(--accent));border:1px solid rgba(255,255,255,0.04)}
.brand h1{margin:0;font-size:20px;letter-spacing:0.6px;font-weight:800}

/* buttons */
.btn{
  background:linear-gradient(180deg,var(--accent),var(--accent-2));
  border:0;color:white;padding:var(--btn-padding);border-radius:var(--btn-radius);cursor:pointer;font-weight:700;box-shadow:0 10px 30px rgba(255,59,59,0.12);transition:transform .14s ease, box-shadow .14s;
  display:inline-flex;align-items:center;gap:8px;
}
.btn:active{transform:translateY(1px)}
.btn.ghost{background:transparent;border:1px solid var(--glass-border);box-shadow:none;color:var(--text)}
.btn.small{padding:6px 8px;font-size:13px;border-radius:10px}
.icon-btn{width:42px;height:42px;display:inline-grid;place-items:center;border-radius:10px;background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent);border:1px solid var(--glass-border);cursor:pointer}

/* layout */
.main{display:grid;grid-template-columns:320px 1fr;gap:16px;margin-top:6px}
@media (max-width:980px){ .main{grid-template-columns:1fr} }

aside.sidebar{padding:14px;border-radius:var(--radius);background:var(--card);border:1px solid var(--glass-border);min-height:320px}
.nav{display:flex;flex-direction:column;gap:8px;margin-top:8px}
.nav button{display:flex;align-items:center;gap:10px;padding:10px;border-radius:10px;background:transparent;border:0;color:var(--muted);cursor:pointer;transition:all .18s}
.nav button.active{background:linear-gradient(90deg, rgba(255,59,59,0.08), rgba(255,59,59,0.03));color:var(--text);box-shadow:inset 0 1px 0 rgba(255,255,255,0.02)}
.search{margin-top:12px;display:flex;gap:8px}
.search input{flex:1;padding:10px;border-radius:10px;background:transparent;border:1px solid var(--glass-border);color:var(--text)}
.small-muted{font-size:13px;color:var(--muted);margin-top:10px}

/* content */
section.content{padding:14px;border-radius:var(--radius);background:var(--card);border:1px solid var(--glass-border);min-height:480px}
.grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
@media (max-width:680px){ .grid{grid-template-columns:1fr} }

/* player card */
.player{display:flex;align-items:center;padding:12px;border-radius:12px;background:linear-gradient(135deg, rgba(255,255,255,0.01), transparent);border:1px solid rgba(255,255,255,0.02);transition:transform .16s ease, box-shadow .16s ease;cursor:pointer}
.player:hover{transform:translateY(-6px);box-shadow:0 18px 40px rgba(0,0,0,0.6)}
.avatar{width:64px;height:64px;border-radius:12px;display:grid;place-items:center;font-weight:700;font-size:20px;background:linear-gradient(135deg,#ffffff10,var(--accent));border:1px solid rgba(255,255,255,0.04);object-fit:cover;overflow:hidden}
.avatar img{width:100%;height:100%;object-fit:cover;display:block}
.p-meta{flex:1;padding-left:12px}
.p-meta b{display:block;font-size:16px}
.p-meta .muted{font-size:13px;color:var(--muted)}
.p-stats{display:flex;gap:8px;align-items:center}
.chip{padding:6px 10px;border-radius:999px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03);font-weight:600}

/* table */
.table-wrap{overflow:auto;border-radius:8px}
table{width:100%;border-collapse:collapse;font-size:14px}
th,td{padding:10px;text-align:left;border-bottom:1px solid rgba(255,255,255,0.03);color:var(--muted)}
th{font-weight:700;color:var(--muted);font-size:13px}
tr:hover td{background:linear-gradient(90deg, rgba(255,255,255,0.01), transparent)}

/* modal */
.modal-back{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(2,6,23,0.75);z-index:120;padding:20px}
.modal{width:920px;max-width:100%;border-radius:14px;padding:18px;background:linear-gradient(180deg, rgba(10,10,12,0.98), rgba(12,12,16,0.98));border:1px solid rgba(255,255,255,0.06);box-shadow:0 30px 90px rgba(0,0,0,0.8);max-height:80vh;overflow:auto;position:relative}
.modal .close-x{position:absolute;right:12px;top:12px;width:36px;height:36px;border-radius:8px;display:grid;place-items:center;cursor:pointer;background:transparent;border:1px solid rgba(255,255,255,0.04)}
.modal .close-x:hover{background:rgba(255,255,255,0.02)}
form.row{display:flex;gap:8px;flex-wrap:wrap}
input,select,textarea{padding:10px;border-radius:10px;background:transparent;border:1px solid var(--glass-border);color:var(--text);min-width:0}
textarea{min-height:92px}
.hover-glow:hover{box-shadow:0 12px 40px rgba(255,59,59,0.12);transform:translateY(-4px)}
.muted-small{font-size:12px;color:var(--muted)}
.kv{font-weight:700;color:var(--muted);font-size:13px;margin-top:8px}
.small-pill{padding:6px 8px;border-radius:8px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03);font-size:13px}
.form-row{display:flex;gap:8px;align-items:center}
.event-row{display:flex;gap:8px;align-items:center;margin-bottom:8px}
.event-row input, .event-row select{padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.06)}
.logo-thumb{width:36px;height:36px;border-radius:6px;object-fit:cover;border:1px solid rgba(255,255,255,0.04)}
.player-photo-preview{width:80px;height:80px;border-radius:10px;object-fit:cover;border:1px solid rgba(255,255,255,0.04);display:block;margin-top:6px}
.footer-note{margin-top:8px;font-size:13px;color:var(--muted)}

/* ensures readability */
.modal select, .modal input, .modal textarea, .event-row select, .event-row input {
  background: rgba(0,0,0,0.6) !important;
  color: var(--text) !important;
  border: 1px solid rgba(255,255,255,0.06) !important;
}

/* focus */
button:focus,input:focus,select:focus,textarea:focus{outline:2px solid rgba(255,59,59,0.18);outline-offset:2px}
@media (max-width:480px){
  .avatar{width:56px;height:56px}
  .player-photo-preview{width:64px;height:64px}
}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="app" role="application" aria-label="Salesian League gestionale">
      <!-- Top -->
      <header class="appbar" role="banner" id="headerBar">
        <div id="leagueLogoWrap">
          <!-- logo rendered by JS -->
        </div>
        <div class="brand">
          <h1 id="leagueTitle">SALESIAN LEAGUE</h1>
        </div>
      </header>

      <!-- Main area -->
      <div class="main" style="width:100%">
        <!-- Sidebar -->
        <aside class="sidebar" aria-label="Barra laterale">
          <div style="display:flex;align-items:center;justify-content:space-between">
            <div class="small-muted">Visualizzazioni</div>
            <div class="muted-small">Pin: <span id="pinLabel">****</span></div>
          </div>

          <nav class="nav" id="nav" aria-label="Seleziona vista">
            <button class="active" data-view="players">Giocatori</button>
            <button data-view="matches">Partite</button>
            <button data-view="calendar">Calendario</button>
            <button data-view="rankings">Classifiche</button>
            <button data-view="admin">Admin</button>
          </nav>

          <div class="search" style="margin-top:10px">
            <input id="search" placeholder="Cerca: nome, cognome o data (es. 27/11/2025)" aria-label="Cerca" />
            <button id="importBtn" class="btn ghost small" title="Importa JSON">üìÅ</button>
          </div>

          <div style="margin-top:12px">
            <label class="kv">Filtra per ruolo</label>
            <select id="roleFilter" style="width:100%;margin-top:6px;padding:8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--text)"><option value="">Tutti</option></select>
          </div>
        </aside>

        <!-- Content -->
        <section class="content" id="mainContent" aria-live="polite">
          <!-- Players view -->
          <div id="viewPlayers" class="view">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
              <div>
                <h2 style="margin:0">Giocatori</h2>
                <div class="muted-small">Visualizza, modifica e consulta la cronologia</div>
              </div>
              <div style="display:flex;gap:8px;align-items:center">
                <div class="muted-small">Totale: <span id="totalPlayers">0</span></div>
                <button id="addPlayerBtnTop" class="btn small">+ Giocatore</button>
              </div>
            </div>

            <div class="grid" id="playersGrid" aria-label="Elenco giocatori"></div>
          </div>

          <!-- Matches view -->
          <div id="viewMatches" class="view" style="display:none">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
              <div>
                <h2 style="margin:0">Partite</h2>
                <div class="muted-small">Storico partite, risultati e formazioni</div>
              </div>
              <div>
                <button id="newMatchBtn" class="btn">+ Nuova partita</button>
              </div>
            </div>

            <div class="table-wrap card" style="padding:8px;border-radius:12px;background:transparent;border:0">
              <table aria-label="Tabella partite">
                <thead><tr><th>Data</th><th>Titolo</th><th>Risultato</th><th>Azioni</th></tr></thead>
                <tbody id="matchesTable"></tbody>
              </table>
            </div>
          </div>

          <!-- Calendar view -->
          <div id="viewCalendar" class="view" style="display:none">
            <h2>Calendario</h2>
            <div id="calendarList"></div>
          </div>

          <!-- Rankings view -->
          <div id="viewRankings" class="view" style="display:none">
            <h2>Classifiche</h2>
            <div style="display:grid;gap:12px">
              <div style="padding:10px;border-radius:10px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03)">
                <h4>Top marcatori</h4>
                <div id="rankingGoals"></div>
              </div>
              <div style="padding:10px;border-radius:10px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03)">
                <h4>Top assist</h4>
                <div id="rankingAssists"></div>
              </div>
              <div style="padding:10px;border-radius:10px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03)">
                <h4>Top MVP</h4>
                <div id="rankingMvp"></div>
              </div>
            </div>
          </div>

          <!-- Admin view -->
          <div id="viewAdmin" class="view" style="display:none"></div>

          <footer class="footer-note">Design moderno ‚Ä¢ Ottimizzato per mobile</footer>
        </section>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div id="modal" class="modal-back" role="dialog" aria-hidden="true">
    <div class="modal" id="modalContent"></div>
  </div>

  <!-- Firebase + App logic -->
  <script type="module">
    /********** Firebase initialization (you provided config) **********/
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, onValue, set, push, child, get, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAe8cq6R5XUMV_GyQakNjc5YAPl17DUyE4",
      authDomain: "salesian-league.firebaseapp.com",
      databaseURL: "https://salesian-league-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "salesian-league",
      storageBucket: "salesian-league.firebasestorage.app",
      messagingSenderId: "9508166370",
      appId: "1:9508166370:web:d49e96a8c1d08ff8a09cbb"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    /********** Simple client-side PIN and admin audit log **********/
    // PIN permanent in UI as requested
    const DEFAULT_ADMIN_PIN = '2209';

    // caches kept in memory (synced realtime with DB)
    let playersCache = [];
    let matchesCache = [];
    let metaCache = {};
    let adminCache = { pin: DEFAULT_ADMIN_PIN };
    // admin logs are stored under 'adminLogs'

    // make adminMode accessible globally (kept in sync)
    let adminMode = false;
    window.adminMode = adminMode;

    // helpers for DB paths
    const pathPlayers = ref(db, 'players');
    const pathMatches = ref(db, 'matches');
    const pathMeta = ref(db, 'meta/league');
    const pathAdmin = ref(db, 'admin');
    const pathAdminLogs = ref(db, 'adminLogs');

    // realtime listeners to keep caches in sync
    onValue(pathPlayers, snapshot => {
      const data = snapshot.val() || {};
      playersCache = Object.keys(data).map(k => ({ id: k, ...data[k] }));
      // keep original order by lastName if present
      playersCache.sort((a,b)=> (a.lastName||'').localeCompare(b.lastName||''));
      // if UI is currently players view, re-render
      if(document.getElementById('viewPlayers') && document.getElementById('viewPlayers').style.display !== 'none') renderPlayers(search.value||'');
    });

    onValue(pathMatches, snapshot => {
      const data = snapshot.val() || {};
      matchesCache = Object.keys(data).map(k => ({ id: k, ...data[k] }));
      // sort desc by date
      matchesCache.sort((a,b)=> new Date(b.date) - new Date(a.date));
      if(document.getElementById('viewMatches') && document.getElementById('viewMatches').style.display !== 'none') renderMatches();
      if(document.getElementById('viewCalendar') && document.getElementById('viewCalendar').style.display !== 'none') renderCalendar();
      if(document.getElementById('viewRankings') && document.getElementById('viewRankings').style.display !== 'none') renderRankings();
    });

    onValue(pathMeta, snapshot => {
      metaCache = snapshot.val() || {};
      renderLeagueMeta();
    });

    onValue(pathAdmin, snapshot => {
      const d = snapshot.val() || {};
      adminCache = d;
      if(!adminCache.pin) adminCache.pin = DEFAULT_ADMIN_PIN;
      if(document.getElementById('pinLabel')) document.getElementById('pinLabel').textContent = adminMode? '(admin)' : '****';
    });

    // convenience write helpers
    function dbSet(pathRef, obj){
      return set(pathRef, obj);
    }
    function dbPush(pathRef, obj){
      const n = push(pathRef);
      return set(n, obj);
    }

    async function writeAdminLog(action, details){
      try{
        const entry = { action, details: details||'', ts: new Date().toISOString() };
        await dbPush(pathAdminLogs, entry);
      }catch(e){ console.error('Log error', e); }
    }

    /********** Exported helpers for old code compatibility **********/
    const loadPlayers = ()=> playersCache.slice();
    const savePlayers = (arr)=>{
      // convert array to object keyed by id
      const obj = {};
      (arr||[]).forEach(p=> obj[p.id] = p);
      return dbSet(pathPlayers, obj);
    };
    const loadMatches = ()=> matchesCache.slice();
    const saveMatches = (arr)=>{
      const obj = {};
      (arr||[]).forEach(m=> obj[m.id] = m);
      return dbSet(pathMatches, obj);
    };
    const getAdmin = ()=> (adminCache || { pin: DEFAULT_ADMIN_PIN });
    const saveAdmin = async (o)=>{
      await dbSet(pathAdmin, o);
      await writeAdminLog('admin_update', JSON.stringify(o));
    };
    const getMeta = ()=> (metaCache || {});
    const saveMeta = async (m)=>{
      await dbSet(pathMeta, m);
      await writeAdminLog('meta_update', JSON.stringify(m));
    };

    // utility to ensure seed data exists (only writes if players empty)
    async function seedIfEmpty(){
      const snap = await get(pathPlayers);
      if(!snap.exists()){
        const demo=[];
        const roles = ['Portiere','Difensore','Centrocampista','Attaccante','Esterno'];
        const yearNow = new Date().getFullYear();
        for(let i=1;i<=12;i++){
          demo.push({
            id: 'p_' + Math.random().toString(36).slice(2,9),
            firstName:'Nome'+i,
            lastName:'Cognome'+i,
            birthYear: yearNow - (14 + (i%6)),
            position: roles[i%roles.length],
            ratings: {velocita: Math.round(Math.random()*7)+3, fisico: Math.round(Math.random()*7)+3, tecnica: Math.round(Math.random()*7)+3},
            photo: '',
            mvpCount: 0
          });
        }
        // write keyed by id
        const obj={};
        demo.forEach(d=> obj[d.id]=d);
        await dbSet(pathPlayers, obj);
      }
      // ensure matches exists node
      const mSnap = await get(pathMatches);
      if(!mSnap.exists()) await dbSet(pathMatches, {});
      const admSnap = await get(pathAdmin);
      if(!admSnap.exists()) await dbSet(pathAdmin, { pin: DEFAULT_ADMIN_PIN });
      const metaSnap = await get(pathMeta);
      if(!metaSnap.exists()) await dbSet(pathMeta, { leagueTitle: 'SALESIAN LEAGUE', leagueLogo: '' });
    }
    // run seeding
    seedIfEmpty().catch(()=>{});

    /********** Now the remainder of your UI code (kept behaviour, with small adjustments)
     *  - we will reuse the same DOM elements and functions from your original file,
     *    but we replaced localStorage with Firebase-backed helpers above.
     **********/
  </script>

<script>
/* VERS. fc_players_v5, matches_v5, admin_v5, meta saved in fc_meta_v1
   - MVP saved on players as mvpCount (recomputed on match changes)
   - role filter in sidebar
   - closeModal/openModal exposed to window so close-x works
   - +Giocatore and +Nuova partita buttons present (require admin) */
document.addEventListener('DOMContentLoaded', ()=>{

  const uid = ()=>Math.random().toString(36).slice(2,9);

  // refs
  const nav = document.getElementById('nav');
  const views = document.querySelectorAll('.view');
  const playersGrid = document.getElementById('playersGrid');
  const matchesTable = document.getElementById('matchesTable');
  const calendarList = document.getElementById('calendarList');
  const modalBack = document.getElementById('modal');
  const modalContent = document.getElementById('modalContent');
  const importBtn = document.getElementById('importBtn');
  const search = document.getElementById('search');
  const totalPlayersLabel = document.getElementById('totalPlayers');
  const pinLabel = document.getElementById('pinLabel');
  const newMatchBtn = document.getElementById('newMatchBtn');
  const addPlayerBtnTop = document.getElementById('addPlayerBtnTop');
  const roleFilter = document.getElementById('roleFilter');
  const leagueTitleEl = document.getElementById('leagueTitle');
  const leagueLogoWrap = document.getElementById('leagueLogoWrap');

  // adminMode declared earlier in module; keep a local ref and keep window.adminMode in sync
  // note: window.adminMode was set in module scope; we mirror it here
  if(typeof window.adminMode === 'undefined') window.adminMode = false;

  let adminModeLocal = window.adminMode;

  // expose openModal/closeModal globally so inline onclick works
  window.openModal = openModal;
  window.closeModal = closeModal;

  // init league meta
  function renderLeagueMeta(){
    const meta = getMeta();
    leagueTitleEl.textContent = meta.leagueTitle || 'SALESIAN LEAGUE';
    leagueLogoWrap.innerHTML = '';
    if(meta.leagueLogo){
      const d = document.createElement('div'); d.className='league-logo'; d.innerHTML = `<img src="${meta.leagueLogo}" style="width:100%;height:100%;object-fit:cover">`;
      leagueLogoWrap.appendChild(d);
    } else {
      // placeholder small logo circle
      const d = document.createElement('div'); d.className='league-logo'; d.innerHTML = `<div style="font-weight:800;color:#fff">${(meta.leagueTitle||'S').charAt(0)}</div>`;
      leagueLogoWrap.appendChild(d);
    }
  }
  renderLeagueMeta();

  if(pinLabel) pinLabel.textContent = '****';

  // nav
  nav.addEventListener('click', e=>{
    if(e.target.matches('button')){
      [...nav.querySelectorAll('button')].forEach(b=>b.classList.remove('active'));
      e.target.classList.add('active');
      showView(e.target.dataset.view);
    }
  });
  function showView(name){
    views.forEach(v=>v.style.display='none');
    const el = document.getElementById('view'+capitalize(name));
    if(el) el.style.display = 'block';
    if(name==='players') renderPlayers(search.value||'');
    if(name==='matches') renderMatches();
    if(name==='calendar') renderCalendar();
    if(name==='admin') renderAdmin();
    if(name==='rankings') renderRankings();
  }
  function capitalize(s){return s? s.charAt(0).toUpperCase()+s.slice(1):''}

  // expose to global so UI buttons and inline handlers can call them reliably
  window.showView = showView;

  // escape
  function escapeHTML(s){ if(!s && s!==0) return ''; return String(s).replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

  // age
  function ageFromBirthYear(birthYear){
    if(!birthYear) return 'N/D';
    const y = Number(birthYear);
    if(isNaN(y)) return 'N/D';
    const now = new Date().getFullYear();
    return now - y;
  }

  // compute stats including mvpCount (reads stored mvpCount but kept in sync by updateMvpCounts)
  function computePlayerStats(playerId){
    const players = loadPlayers();
    const p = players.find(x=>x.id===playerId) || {mvpCount:0};
    // compute goals/assists/played from matches
    const matches = loadMatches();
    let goals=0, assists=0, played=0;
    matches.forEach(m=>{
      (m.formations||[]).forEach(f=>{
        (f.players||[]).forEach(pl=>{
          if(pl.playerId === playerId) played++;
        });
      });
      (m.events||[]).forEach(ev=>{
        if(ev.type === 'goal' && ev.playerId === playerId) goals++;
        if(ev.type === 'penalty' && ev.playerId === playerId) goals++;
        if(ev.type === 'assist' && ev.playerId === playerId) assists++;
      });
    });
    return {goals, assists, played, mvps: p.mvpCount || 0};
  }

  // calculate avg rating
  function calcPlayerAvg(playerId){
    const matches = loadMatches();
    let sum=0,count=0;
    matches.forEach(m=>{
      (m.formations||[]).forEach(f=>{
        (f.players||[]).forEach(pl=>{
          if(pl.playerId===playerId && pl.rating!=null && pl.rating!==''){
            sum += Number(pl.rating); count++;
          }
        })
      })
    });
    return count? sum/count : NaN;
  }

  // update mvp counts based on matches' events (synchronizes players.mvpCount)
  function updateMvpCounts(){
    const players = loadPlayers();
    // reset
    players.forEach(p => p.mvpCount = 0);
    const matches = loadMatches();
    matches.forEach(m=>{
      (m.events||[]).forEach(ev=>{
        if(ev.type === 'mvp' && ev.playerId){
          const pl = players.find(p=>p.id===ev.playerId);
          if(pl) pl.mvpCount = (pl.mvpCount||0) + 1;
        }
      });
    });
    // save players (persist mvp counts)
    savePlayers(players);
  }

  // Render role filter options
  function refreshRoleFilter(){
    const players = loadPlayers();
    const roles = new Set(players.map(p=>p.position).filter(Boolean));
    // create options with inline style to make selected text readable (text color equals selection background is an accessibility problem)
    const opts = ['<option value="">Tutti</option>'].concat(Array.from(roles).map(r=>`<option value="${escapeHTML(r)}">${escapeHTML(r)}</option>`));
    roleFilter.innerHTML = opts.join('');
    // accessibility improvement: when selection changes ensure contrast by setting select color to default text
    roleFilter.style.color = 'var(--text)';
  }

  // Render players with role filter + search
  function renderPlayers(filter=''){
    const selectedRole = roleFilter.value || '';
    const players = loadPlayers().filter(p => {
      const q = (p.firstName+' '+p.lastName).toLowerCase();
      const matchQ = !filter || q.includes(filter.toLowerCase());
      const matchRole = !selectedRole || (p.position === selectedRole);
      return matchQ && matchRole;
    });
    if(!playersGrid) return;
    playersGrid.innerHTML='';
    if(totalPlayersLabel) totalPlayersLabel.textContent = players.length;
    players.forEach(p=>{
      const avg = calcPlayerAvg(p.id);
      const stats = computePlayerStats(p.id);
      const el = document.createElement('div');
      el.className = 'player hover-glow';
      const avatarHTML = p.photo ? `<div class="avatar"><img src="${p.photo}" alt="foto ${escapeHTML(p.firstName)}"></div>` : `<div class="avatar" aria-hidden="true">${escapeHTML(p.firstName.charAt(0) + p.lastName.charAt(0))}</div>`;
      el.innerHTML = `
        ${avatarHTML}
        <div class="p-meta">
          <b>${escapeHTML(p.firstName)} ${escapeHTML(p.lastName)}</b>
          <div class="muted">${escapeHTML(p.position||'N/D')} ‚Ä¢ ${ageFromBirthYear(p.birthYear)} anni ‚Ä¢ <span class="muted-small">Media: ${isNaN(avg)?'-':avg.toFixed(2)}</span></div>
          <div class="muted-small kv">G:${stats.goals} ‚Ä¢ A:${stats.assists} ‚Ä¢ P:${stats.played} ‚Ä¢ MVP:${stats.mvps}</div>
        </div>
        <div style="display:flex;flex-direction:column;align-items:flex-end;gap:8px">
          <div class="p-stats"><div class="chip">${isNaN(avg)?'‚Äî':avg.toFixed(2)}</div></div>
          <div style="display:flex;gap:6px">
            <button class="btn ghost small" onclick="viewPlayer('${p.id}')">Apri</button>
            ${adminModeLocal ? `<button class="btn" onclick="openEditPlayer('${p.id}')">Modifica</button><button class="btn ghost" onclick="deletePlayer('${p.id}')">Elimina</button>` : ''}
          </div>
        </div>
      `;
      el.addEventListener('click', (ev)=>{ if(ev.target.tagName.toLowerCase()!=='button') viewPlayer(p.id) });
      playersGrid.appendChild(el);
    });
    refreshRoleFilter();
  }

  // View player modal
  window.viewPlayer = function(id){
    const p = loadPlayers().find(x=>x.id===id);
    if(!p) return alert('Giocatore non trovato');
    const matches = loadMatches().filter(m=> (m.formations||[]).some(f=> (f.players||[]).some(pl=>pl.playerId===id)));
    const avg = calcPlayerAvg(id);
    const stats = computePlayerStats(id);

    let photoHTML = p.photo ? `<img src="${p.photo}" alt="foto" style="width:110px;height:110px;border-radius:10px;object-fit:cover">` : `<div style="width:110px;height:110px;border-radius:10px;background:linear-gradient(135deg,#ffffff10,var(--accent));display:grid;place-items:center;font-weight:800;font-size:34px">${escapeHTML(p.firstName.charAt(0)+p.lastName.charAt(0))}</div>`;

    let html = `<div class="close-x" title="Chiudi" onclick="closeModal()">‚úï</div>`;
    html += `<div style="display:flex;gap:12px;align-items:center">
      ${photoHTML}
      <div><h3 style="margin:0">${escapeHTML(p.firstName)} ${escapeHTML(p.lastName)}</h3><div class="muted-small">Anno di nascita: ${p.birthYear || 'N/D'} ‚Ä¢ Ruolo: ${escapeHTML(p.position||'N/D')}</div>
      <div class="muted-small kv">Et√†: ${ageFromBirthYear(p.birthYear)} ‚Ä¢ Media: ${isNaN(avg)?'-':avg.toFixed(2)} ‚Ä¢ Partite: ${stats.played} ‚Ä¢ Goal: ${stats.goals} ‚Ä¢ Assist: ${stats.assists} ‚Ä¢ MVP: ${stats.mvps}</div></div>
      <div style="margin-left:auto">${adminModeLocal?`<button class='btn' onclick="openEditPlayer('${p.id}')">Modifica</button>`:''}</div>
    </div>`;

    html += `<hr style="margin:12px 0;border:none;border-top:1px solid rgba(255,255,255,0.06)"><h4>Scheda tecnica (0-10)</h4>
      <div style="display:flex;gap:12px;flex-wrap:wrap">
        <div class="small-pill">Velocit√†: ${p.ratings?.velocita ?? '-'}</div>
        <div class="small-pill">Fisico: ${p.ratings?.fisico ?? '-'}</div>
        <div class="small-pill">Tecnica: ${p.ratings?.tecnica ?? '-'}</div>
      </div>`;

    html += `<hr style="margin:12px 0;border:none;border-top:1px solid rgba(255,255,255,0.06)"><h4>Cronologia partite</h4>`;
    if(matches.length===0) html += `<div class="muted-small">Nessuna partita registrata</div>`;
    else{
      html += `<div style="display:grid;gap:8px">`;
      matches.forEach(m=>{
        const result = computeScore(m);
        html += `<div style="padding:10px;border-radius:10px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03)">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div><b>${escapeHTML(m.title)}</b><div class="muted-small">${new Date(m.date).toLocaleDateString()}</div></div>
            <div style="text-align:right">${escapeHTML(result)}</div>
          </div>
          <div style="margin-top:8px"><button class="btn ghost small" onclick="viewMatch('${m.id}')">Vedi partita</button></div>
        </div>`;
      });
      html += `</div>`;
    }

    openModal(html);
  }

  // openEditPlayer (admin) - includes remove photo and birthYear
  window.openEditPlayer = function(id){
    if(!adminModeLocal) return alert('Devi essere admin per modificare');
    const p = loadPlayers().find(x=>x.id===id) || {};
    openModal(`<div class="close-x" title="Chiudi" onclick="closeModal()">‚úï</div><h3>Modifica Giocatore</h3>
      <form id="editPlayerForm" class="row">
        <input name="firstName" value="${escapeHTML(p.firstName||'')}" required />
        <input name="lastName" value="${escapeHTML(p.lastName||'')}" required />
        <input name="birthYear" type="number" min="1900" max="${new Date().getFullYear()}" value="${escapeHTML(p.birthYear||'')}" placeholder="Anno di nascita" required />
        <input name="position" value="${escapeHTML(p.position||'')}" placeholder="Ruolo (es: Attaccante)" />
        <div style="width:100%"><label class="kv">Scheda tecnica (0-10)</label>
          <div style="display:flex;gap:8px;margin-top:6px">
            <input name="velocita" type="number" min="0" max="10" value="${escapeHTML(p.ratings?.velocita||'')}" placeholder="Velocit√†" />
            <input name="fisico" type="number" min="0" max="10" value="${escapeHTML(p.ratings?.fisico||'')}" placeholder="Fisico" />
            <input name="tecnica" type="number" min="0" max="10" value="${escapeHTML(p.ratings?.tecnica||'')}" placeholder="Tecnica" />
          </div>
        </div>

        <div style="width:100%">
          <label class="kv">Foto giocatore (png/jpg)</label>
          <input id="playerPhotoInput" name="photo" type="file" accept="image/*" />
          <img id="playerPhotoPreview" class="player-photo-preview" src="${p.photo||''}" style="${p.photo?'display:block;':'display:none;'}" alt="preview">
          ${p.photo?'<div style="margin-top:6px"><button id="removePhotoBtn" class="btn ghost small" type="button">Rimuovi foto</button></div>':''}
        </div>

        <div style="margin-left:auto;display:flex;gap:8px">
          <button class="btn" type="submit">Salva</button>
          <button class="btn ghost" id="deletePlayerBtn" type="button">Elimina giocatore</button>
        </div>
      </form>`);

    const photoInput = document.getElementById('playerPhotoInput');
    const preview = document.getElementById('playerPhotoPreview');
    const removePhotoBtn = document.getElementById('removePhotoBtn');

    photoInput.addEventListener('change', e=>{
      const f = e.target.files[0];
      if(!f) return;
      const r = new FileReader();
      r.onload = ev=>{ preview.src = ev.target.result; preview.style.display='block'; if(!removePhotoBtn){ const btn = document.createElement('button'); btn.className='btn ghost small'; btn.id='removePhotoBtn'; btn.type='button'; btn.textContent='Rimuovi foto'; btn.addEventListener('click', ()=>{ preview.src=''; preview.style.display='none'; photoInput.value=''; }); document.querySelector('#editPlayerForm div[style*="width:100%"]').appendChild(btn);} };
      r.readAsDataURL(f);
    });

    if(removePhotoBtn){
      removePhotoBtn.addEventListener('click', ()=>{
        preview.src=''; preview.style.display='none';
        p.photo = '';
      });
    }

    document.getElementById('editPlayerForm').addEventListener('submit', e=>{
      e.preventDefault();
      const fd = new FormData(e.target);
      p.firstName = fd.get('firstName');
      p.lastName = fd.get('lastName');
      p.birthYear = fd.get('birthYear');
      p.position = fd.get('position');
      p.ratings = {velocita: Number(fd.get('velocita')||0), fisico: Number(fd.get('fisico')||0), tecnica: Number(fd.get('tecnica')||0)};
      const file = photoInput.files[0];
      if(file){
        const reader = new FileReader();
        reader.onload = ev=>{
          p.photo = ev.target.result;
          // save to Firebase via savePlayers: loadPlayers array replaced earlier with Firebase-backed function
          const players = loadPlayers().map(x=> x.id===p.id? p : x );
          savePlayers(players).then(()=>{ closeModal(); renderPlayers(); alert('Giocatore aggiornato'); writeAdminLog('player_update','Aggiornato '+p.id); }).catch(()=>alert('Errore salvataggio'));
        };
        reader.readAsDataURL(file);
      } else {
        const players = loadPlayers().map(x=> x.id===p.id? p : x );
        savePlayers(players).then(()=>{ closeModal(); renderPlayers(); alert('Giocatore aggiornato'); writeAdminLog('player_update','Aggiornato '+p.id); }).catch(()=>alert('Errore salvataggio'));
      }
    });

    document.getElementById('deletePlayerBtn').addEventListener('click', ()=>{
      if(confirm('Sei sicuro di voler eliminare questo giocatore?')){ deletePlayer(p.id); }
    });
  }

  // delete player
  window.deletePlayer = function(id){
    if(!adminModeLocal) return alert('Devi essere admin per eliminare');
    if(!confirm('Eliminare il giocatore?')) return;
    let players = loadPlayers().filter(p=>p.id!==id);
    savePlayers(players).then(()=>{
      // remove from matches
      const matches = loadMatches();
      matches.forEach(m=> (m.formations||[]).forEach(f => f.players = (f.players||[]).filter(pl => pl.playerId !== id)));
      saveMatches(matches).then(()=>{
        // after modifying matches, recompute mvp counts
        updateMvpCounts();
        closeModal();
        renderPlayers(search.value);
        renderMatches();
        writeAdminLog('player_delete', 'Eliminato '+id);
        alert('Giocatore eliminato');
      });
    }).catch(()=>alert('Errore eliminazione'));
  }

  // Matches rendering
  function renderMatches(){
    const matches = loadMatches().sort((a,b)=> new Date(b.date) - new Date(a.date));
    if(!matchesTable) return;
    matchesTable.innerHTML = '';
    if(matches.length===0){ matchesTable.innerHTML = '<tr><td colspan="4" class="muted-small">Nessuna partita registrata</td></tr>'; return; }
    matches.forEach(m=>{
      const result = computeScore(m);
      const tr = document.createElement('tr');
      const logosHTML = (m.formations||[]).map((f,fi)=> f.teamLogo ? `<img src="${f.teamLogo}" class="logo-thumb" alt="logo">` : '').join(' ');
      tr.innerHTML = `<td>${new Date(m.date).toLocaleDateString()}</td><td>${escapeHTML(m.title)}<div style="margin-top:6px">${logosHTML}</div></td><td>${escapeHTML(result)}</td><td><button class="btn ghost small" onclick="viewMatch('${m.id}')">Apri</button> ${adminModeLocal? `<button class="btn" onclick="openEditMatch('${m.id}')">Modifica</button> <button class="btn ghost" onclick="deleteMatch('${m.id}')">Elimina</button>`: ''}</td>`;
      matchesTable.appendChild(tr);
    });
  }

  // computeScore (counts goal & penalty events)
  function computeScore(m){
    const teams = (m.formations||[]).map(f=>f.teamName||'Team');
    const goalsByTeam = new Array(teams.length).fill(0);
    (m.events||[]).forEach(ev=>{
      if((ev.type==='goal' || ev.type==='penalty') && typeof ev.teamIndex === 'number') goalsByTeam[ev.teamIndex] = (goalsByTeam[ev.teamIndex]||0)+1;
      // note: mvp doesn't affect score
    });
    if(teams.length>0) return teams.map((t,i)=>goalsByTeam[i]||0).join(' - ');
    return m.score || '-';
  }

  // View match
  window.viewMatch = function(id){
    const m = loadMatches().find(x=>x.id===id);
    if(!m) return alert('Partita non trovata');
    let titleHTML = `<div class="close-x" title="Chiudi" onclick="closeModal()">‚úï</div><div style="display:flex;align-items:center;gap:12px"><h2 style="margin:0">${escapeHTML(m.title)}</h2><div style="margin-left:auto" class="muted-small">${new Date(m.date).toLocaleDateString()}</div></div><hr style="margin:8px 0;border:none;border-top:1px solid rgba(255,255,255,0.06)">`;
    let html = titleHTML;
    html += `<div style="margin-top:6px">${m.notes?escapeHTML(m.notes):'<span class="muted-small">Nessuna nota</span>'}</div>`;

    html += `<div style="display:flex;gap:12px;margin-top:10px;align-items:center">`;
    (m.formations||[]).forEach((f,fi)=>{
      html += `<div style="display:flex;align-items:center;gap:8px"><div style="display:flex;flex-direction:column;align-items:center"><div style="width:56px;height:56px;border-radius:8px;overflow:hidden;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03)">${f.teamLogo?`<img src="${f.teamLogo}" style="width:56px;height:56px;object-fit:cover">`:`<div style="width:100%;height:100%;display:grid;place-items:center">${escapeHTML(f.teamName?f.teamName.charAt(0):'T')}</div>`}</div><div class="muted-small" style="margin-top:6px">${escapeHTML(f.teamName)}</div></div></div>`;
    });
    html += `</div>`;

    html += `<hr style="margin:12px 0;border:none;border-top:1px solid rgba(255,255,255,0.06)"><h4>Timeline eventi</h4>`;
    if(!(m.events||[]).length) html += `<div class="muted-small">Nessun evento registrato</div>`;
    else{
      const eventsSorted = (m.events||[]).slice().sort((a,b)=> a.minute - b.minute);
      html += `<div style="display:grid;gap:8px">`;
      eventsSorted.forEach(ev=>{
        const player = (loadPlayers().find(p=>p.id===ev.playerId) || {firstName:'(rimosso)', lastName:''});
        const assistPlayer = ev.assistTo? (loadPlayers().find(p=>p.id===ev.assistTo) || {firstName:'(rimosso)'}) : null;
        html += `<div style="padding:8px;border-radius:8px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03)"><b>${ev.type==='mvp'? escapeHTML('MVP') : escapeHTML((ev.minute||'') + "' - " + ev.type.toUpperCase())}</b> ‚Ä¢ ${escapeHTML(player.firstName)} ${escapeHTML(player.lastName)} ${assistPlayer?`‚Ä¢ Assist: ${escapeHTML(assistPlayer.firstName+' '+(assistPlayer.lastName||''))}`:''}</div>`;
      });
      html += `</div>`;
    }

    html += `<hr style="margin:12px 0;border:none;border-top:1px solid rgba(255,255,255,0.06)"><div style="display:grid;gap:10px">`;
    (m.formations||[]).forEach((f,fi)=>{
      html += `<div style="padding:10px;border-radius:10px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03)"><b>${escapeHTML(f.teamName)}</b>
        <table style="width:100%;margin-top:8px"><thead><tr><th>Giocatore</th><th>Ruolo</th><th>Voto</th></tr></thead><tbody>
        ${ (f.players||[]).map(pl=>{
          const g = loadPlayers().find(pp=>pp.id===pl.playerId) || {firstName:'(rimosso)',lastName:''};
          return `<tr><td>${escapeHTML(g.firstName)} ${escapeHTML(g.lastName)}</td><td>${escapeHTML(pl.position||g.position||'-')}</td><td>${escapeHTML(pl.rating||'-')}</td></tr>`;
        }).join('')}
        </tbody></table></div>`;
    });
    html += `</div>`;

    openModal(html);
  }

  // delete match
  window.deleteMatch = function(id){
    if(!adminModeLocal) return alert('Devi essere admin per modificare');
    if(!confirm('Eliminare la partita?')) return;
    let matches = loadMatches().filter(m=>m.id!==id);
    saveMatches(matches).then(()=>{
      // recompute mvp counts
      updateMvpCounts();
      renderMatches();
      closeModal();
      writeAdminLog('match_delete','Eliminata '+id);
      alert('Partita eliminata');
    }).catch(()=>alert('Errore eliminazione'));
  }

  // openEditMatch (admin) with MVP event option
  window.openEditMatch = function(id){
    if(!adminModeLocal) return alert('Devi essere admin per modificare');
    const m = loadMatches().find(x=>x.id===id);
    const players = loadPlayers();

    let formationsHTML = '';
    (m.formations||[]).forEach((f,fi)=>{
      formationsHTML += `<div style="padding:8px;border-radius:10px;background:rgba(255,255,255,0.01);margin-bottom:8px">
        <b>Formazione: <input name="teamName_${fi}" value="${escapeHTML(f.teamName)}" /></b>
        <div style="margin-top:6px;display:flex;gap:8px;align-items:center">
          <div>Logo squadra:</div>
          <input name="teamLogoFile_${fi}" type="file" accept="image/*" />
          <img id="teamLogoPreview_${fi}" class="logo-thumb" src="${f.teamLogo||''}" style="${f.teamLogo?'display:block;':'display:none;'}" alt="preview">
        </div>
        <table style="width:100%;margin-top:8px"><thead><tr><th>Giocatore</th><th>Ruolo</th><th>Voto</th><th>Rimuovi</th></tr></thead><tbody>`;
      (f.players||[]).forEach((pl,pi)=>{
        const g = players.find(pp=>pp.id===pl.playerId) || {firstName:'(rimosso)',lastName:''};
        formationsHTML += `<tr>
          <td>${escapeHTML(g.firstName)} ${escapeHTML(g.lastName)}<input type="hidden" name="playerId_${fi}_${pi}" value="${escapeHTML(pl.playerId)}"></td>
          <td><input name="position_${fi}_${pi}" value="${escapeHTML(pl.position||'')}" /></td>
          <td><input name="rating_${fi}_${pi}" value="${escapeHTML(pl.rating||'')}" /></td>
          <td><input type="checkbox" name="keep_${fi}_${pi}" checked></td>
        </tr>`;
      });
      formationsHTML += `</tbody></table></div>`;
    });

    let eventsHTML = `<div id="eventsContainer" style="display:grid;gap:8px">`;
    (m.events||[]).forEach(ev=>{
      eventsHTML += singleEventRowHTML(ev, m.formations || []);
    });
    eventsHTML += `</div><div style="margin-top:8px"><button id="addEventBtn" class="btn ghost small" type="button">+ Aggiungi evento</button></div>`;

    openModal(`<div class="close-x" title="Chiudi" onclick="closeModal()">‚úï</div><h3>Modifica partita</h3>
      <form id="editMatchForm" class="row">
        <input name="title" value="${escapeHTML(m.title || '')}" required />
        <input name="date" type="date" value="${new Date(m.date).toISOString().slice(0,10)}" required />
        <textarea name="notes" placeholder="Note...">${escapeHTML(m.notes||'')}</textarea>
        ${formationsHTML}
        <hr style="margin:8px 0;border:none;border-top:1px solid rgba(255,255,255,0.06)">
        <label class="kv">Eventi partita (MVP disponibile)</label>
        ${eventsHTML}
        <div style="margin-left:auto;display:flex;gap:8px">
          <button class="btn" type="submit">Salva</button>
          <button class="btn ghost" id="deleteMatchBtn" type="button">Elimina partita</button>
        </div>
      </form>`);

    // preview for logos
    (m.formations||[]).forEach((f,fi)=>{
      const fileInput = modalContent.querySelector(`[name="teamLogoFile_${fi}"]`);
      const previewImg = document.getElementById(`teamLogoPreview_${fi}`);
      if(fileInput){
        fileInput.addEventListener('change', e=>{
          const file = e.target.files[0];
          if(!file) return;
          const r = new FileReader();
          r.onload = ev=>{ previewImg.src = ev.target.result; previewImg.style.display='block'; };
          r.readAsDataURL(file);
        });
      }
    });

    document.getElementById('addEventBtn').addEventListener('click', (e)=>{
      e.preventDefault();
      const container = document.getElementById('eventsContainer');
      container.insertAdjacentHTML('beforeend', singleEventRowHTML({minute:90,type:'goal',teamIndex:0,playerId:'',assistTo:''}, m.formations || []));
    });

    document.getElementById('deleteMatchBtn').addEventListener('click', ()=>{
      if(confirm('Sei sicuro di voler eliminare questa partita?')){ deleteMatch(m.id); }
    });

    document.getElementById('editMatchForm').addEventListener('submit', async e=>{
      e.preventDefault();
      const fd = new FormData(e.target);
      m.title = fd.get('title'); m.date = fd.get('date'); m.notes = fd.get('notes');

      m.formations.forEach((f,fi)=>{
        f.teamName = fd.get(`teamName_${fi}`) || f.teamName;
        const logoFileInput = modalContent.querySelector(`[name="teamLogoFile_${fi}"]`);
        if(logoFileInput && logoFileInput.files && logoFileInput.files[0]){
          function readFileAsDataURL(file){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=ev=>res(ev.target.result); r.onerror=err=>rej(err); r.readAsDataURL(file); }) }
          f._logoPromise = readFileAsDataURL(logoFileInput.files[0]);
        }
        f.players.forEach((pl,pi)=>{
          if(!fd.get(`keep_${fi}_${pi}`)) { pl._remove = true; return; }
          pl.position = fd.get(`position_${fi}_${pi}`) || pl.position;
          pl.rating = fd.get(`rating_${fi}_${pi}`) || pl.rating;
        });
        f.players = f.players.filter(p=>!p._remove);
        f.players.forEach(p=> delete p._remove );
      });

      // events
      const evRows = modalContent.querySelectorAll('.event-row');
      const newEvents = [];
      evRows.forEach(row=>{
        const type = row.querySelector('.ev-type').value || 'goal';
        // if MVP, ignore minute and assist (MVP is a post-match award)
        if(type === 'mvp'){
          const playerId = row.querySelector('.ev-player').value || '';
          if(playerId) newEvents.push({ minute: null, type: 'mvp', teamIndex: null, playerId, assistTo: null });
          return;
        }
        const minute = Number(row.querySelector('.ev-minute').value || 0);
        const teamIndex = Number(row.querySelector('.ev-team').value || 0);
        const playerId = row.querySelector('.ev-player').value || '';
        const assistTo = row.querySelector('.ev-assist').value || '';
        if(playerId) newEvents.push({minute, type, teamIndex, playerId, assistTo: assistTo || null});
      });

      // ensure only one MVP per match: keep last MVP (if multiple found) - reduce to single entry
      const mvps = newEvents.filter(ev=>ev.type==='mvp');
      if(mvps.length>1){
        // keep last, remove others
        const last = mvps[mvps.length-1];
        // remove all existing mvp events
        for(let i=newEvents.length-1;i>=0;i--) if(newEvents[i].type==='mvp') newEvents.splice(i,1);
        newEvents.push(last);
      }

      m.events = newEvents;

      const logoPromises = [];
      m.formations.forEach((f)=>{
        if(f._logoPromise){ logoPromises.push(f._logoPromise.then(dataUrl=>{ f.teamLogo = dataUrl; delete f._logoPromise; })); }
      });
      await Promise.all(logoPromises);

      saveMatches(loadMatches().map(x=> x.id===m.id? m : x )).then(()=>{
        // after saving match changes, recompute MVP counts
        updateMvpCounts();
        closeModal(); renderMatches(); renderPlayers(); writeAdminLog('match_update','Aggiornata '+m.id); alert('Partita aggiornata');
      }).catch(()=>alert('Errore salvataggio'));
    });
  }

  // helper: event row includes mvp option and penalty selection
  function singleEventRowHTML(ev, formations){
    const teamOptions = (formations.length>0) ? formations.map((f,i)=>`<option value="${i}" ${i===ev.teamIndex?'selected':''}>${escapeHTML(f.teamName||('Team '+(i+1)))}</option>`).join('') : `<option value="0">Team A</option><option value="1">Team B</option>`;
    const players = loadPlayers();
    const playersOptions = players.map(p=>`<option value="${p.id}" ${p.id===ev.playerId?'selected':''}>${escapeHTML(p.firstName+' '+p.lastName)}</option>`).join('');
    const assistOptions = `<option value="">-</option>` + playersOptions;
    return `<div class="event-row" style="padding:6px;border-radius:8px;background:rgba(255,255,255,0.01);border:1px solid rgba(255,255,255,0.03)">
      <input class="ev-minute" style="width:60px" type="number" min="0" max="120" value="${escapeHTML(ev.minute||'')}" placeholder="min" />
      <select class="ev-type">
        <option ${ev.type==='goal'?'selected':''} value="goal">Goal</option>
        <option ${ev.type==='assist'?'selected':''} value="assist">Assist</option>
        <option ${ev.type==='own'?'selected':''} value="own">Autogol</option>
        <option ${ev.type==='penalty'?'selected':''} value="penalty">Rigore</option>
        <option ${ev.type==='yellow'?'selected':''} value="yellow">Ammonizione</option>
        <option ${ev.type==='red'?'selected':''} value="red">Espulsione</option>
        <option ${ev.type==='sub'?'selected':''} value="sub">Sostituzione</option>
        <option ${ev.type==='mvp'?'selected':''} value="mvp">MVP</option>
      </select>
      <select class="ev-team">${teamOptions}</select>
      <select class="ev-player">${playersOptions}</select>
      <select class="ev-assist">${assistOptions}</select>
      <button class="btn ghost small" type="button" onclick="this.closest('.event-row').remove()">Rimuovi</button>
    </div>`;
  }

  // openAddMatchModal (admin)
  function openAddMatchModal(){
    const players = loadPlayers();
    openModal(`<div class="close-x" title="Chiudi" onclick="closeModal()">‚úï</div><h3>Nuova Partita</h3>
      <form id="newMatchForm" class="row">
        <input name="title" placeholder="Titolo (es: Amichevole vs Torre)" required />
        <input name="date" type="date" required />
        <textarea name="notes" placeholder="Note..."></textarea>
        <div style="display:flex;gap:8px">
          <div style="flex:1"><b>Formazione A</b><input name="teamA_name" placeholder="Nome squadra A" /><input name="teamA_logo" type="file" accept="image/*" /><select id="teamA_select" multiple style="height:140px">${players.map(p=>`<option value="${p.id}">${escapeHTML(p.firstName+' '+p.lastName)}</option>`).join('')}</select></div>
          <div style="flex:1"><b>Formazione B</b><input name="teamB_name" placeholder="Nome squadra B" /><input name="teamB_logo" type="file" accept="image/*" /><select id="teamB_select" multiple style="height:140px">${players.map(p=>`<option value="${p.id}">${escapeHTML(p.firstName+' '+p.lastName)}</option>`).join('')}</select></div>
        </div>
        <div style="margin-left:auto"><button class="btn" type="submit">Crea partita</button></div>
      </form>`);

    document.getElementById('newMatchForm').addEventListener('submit', e=>{
      e.preventDefault();
      if(!adminModeLocal){ if(!adminPrompt()) return; } // ask login
      const fd = new FormData(e.target);
      const teamA = [...document.getElementById('teamA_select').selectedOptions].map(o=>o.value);
      const teamB = [...document.getElementById('teamB_select').selectedOptions].map(o=>o.value);
      const teamAName = fd.get('teamA_name') || 'Team A';
      const teamBName = fd.get('teamB_name') || 'Team B';

      const m = {id:uid(), title:fd.get('title'), date:fd.get('date'), notes:fd.get('notes'), formations:[
        {teamName:teamAName, players: teamA.map(pid=>({playerId:pid, position:'', rating:''})), teamLogo: ''},
        {teamName:teamBName, players: teamB.map(pid=>({playerId:pid, position:'', rating:''})), teamLogo: ''}
      ], events: []};

      const fileA = document.querySelector('[name="teamA_logo"]').files[0];
      const fileB = document.querySelector('[name="teamB_logo"]').files[0];
      const promises = [];
      if(fileA){
        promises.push(new Promise((res,rej)=>{
          const r=new FileReader(); r.onload=ev=>{ m.formations[0].teamLogo = ev.target.result; res(); }; r.onerror=rej; r.readAsDataURL(fileA);
        }));
      }
      if(fileB){
        promises.push(new Promise((res,rej)=>{
          const r=new FileReader(); r.onload=ev=>{ m.formations[1].teamLogo = ev.target.result; res(); }; r.onerror=rej; r.readAsDataURL(fileB);
        }));
      }
      Promise.all(promises).then(()=>{
        const matches = loadMatches(); matches.push(m);
        saveMatches(matches).then(()=>{ updateMvpCounts(); closeModal(); renderMatches(); writeAdminLog('match_create','Creata '+m.id); alert('Partita creata'); }).catch(()=>alert('Errore creazione partita'));
      }).catch(()=>{ alert('Errore caricamento logo'); });
    });
  }
  // expose to global
  window.openAddMatchModal = openAddMatchModal;

  // openAddPlayerModal (admin)
  function openAddPlayerModal(){
    openModal(`<div class="close-x" title="Chiudi" onclick="closeModal()">‚úï</div><h3>Nuovo Giocatore</h3><form id="newPlayerFrm" class="row"><input name="firstName" placeholder="Nome" required /><input name="lastName" placeholder="Cognome" required /><input name="birthYear" type="number" min="1900" max="${new Date().getFullYear()}" placeholder="Anno di nascita" required /><input name="position" placeholder="Ruolo" /><div style="width:100%"><label class="kv">Scheda tecnica (0-10)</label><div style="display:flex;gap:8px;margin-top:6px"><input name="velocita" type="number" min="0" max="10" placeholder="Velocit√†" /><input name="fisico" type="number" min="0" max="10" placeholder="Fisico" /><input name="tecnica" type="number" min="0" max="10" placeholder="Tecnica" /></div></div><div style="width:100%"><label class="kv">Foto giocatore (png/jpg)</label><input id="newPlayerPhoto" name="photo" type="file" accept="image/*" /><img id="newPlayerPreview" class="player-photo-preview" style="display:none"></div><div style="margin-left:auto"><button class="btn" type="submit">Crea</button></div></form>`);

    const newPhoto = document.getElementById('newPlayerPhoto');
    const preview = document.getElementById('newPlayerPreview');
    newPhoto.addEventListener('change', e=>{
      const f = e.target.files[0];
      if(!f) return;
      const r = new FileReader();
      r.onload = ev=>{ preview.src = ev.target.result; preview.style.display='block'; };
      r.readAsDataURL(f);
    });

    document.getElementById('newPlayerFrm').addEventListener('submit', e=>{
      e.preventDefault();
      if(!adminModeLocal){ if(!adminPrompt()) return; } // ask login
      const fd = new FormData(e.target);
      const data = {id:uid(), firstName:fd.get('firstName'), lastName:fd.get('lastName'), birthYear: fd.get('birthYear'), position:fd.get('position'), ratings:{velocita:Number(fd.get('velocita')||0), fisico:Number(fd.get('fisico')||0), tecnica:Number(fd.get('tecnica')||0)}, photo:'', mvpCount:0};
      const file = newPhoto.files[0];
      if(file){
        const r = new FileReader();
        r.onload = ev=>{ data.photo = ev.target.result; const players = loadPlayers(); players.push(data); savePlayers(players).then(()=>{ refreshRoleFilter(); closeModal(); renderPlayers(); writeAdminLog('player_create','Creato '+data.id); alert('Giocatore aggiunto'); }).catch(()=>alert('Errore salvataggio')); };
        r.readAsDataURL(file);
      } else {
        const players = loadPlayers(); players.push(data); savePlayers(players).then(()=>{ refreshRoleFilter(); closeModal(); renderPlayers(); writeAdminLog('player_create','Creato '+data.id); alert('Giocatore aggiunto'); }).catch(()=>alert('Errore salvataggio'));
      }
    });
  }
  // expose to global
  window.openAddPlayerModal = openAddPlayerModal;

  // export/import
  function exportJSON(){
    const dump = {players: loadPlayers(), matches: loadMatches(), admin: getAdmin(), meta: getMeta()};
    const blob = new Blob([JSON.stringify(dump, null, 2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'salesian-league-backup.json'; a.click();
  }
  function importJSONFromFile(file){
    const r = new FileReader();
    r.onload = ev => {
      try{
        const data = JSON.parse(ev.target.result);
        if(data.players) savePlayers(data.players);
        if(data.matches) saveMatches(data.matches);
        if(data.admin) saveAdmin(data.admin);
        if(data.meta) saveMeta(data.meta);
        // sync mvp after import
        updateMvpCounts();
        renderLeagueMeta();
        renderPlayers(); renderMatches(); alert('Import completato');
        writeAdminLog('import','Import JSON');
      }catch(err){ alert('File non valido') }
    }; r.readAsText(file);
  }
  if(importBtn){
    importBtn.addEventListener('click', ()=>{
      const ta = document.createElement('input'); ta.type='file'; ta.accept='application/json'; ta.onchange = e=>{
        const f = e.target.files[0];
        if(f) importJSONFromFile(f);
      }; ta.click();
    });
  }

  // search: date or name + role filter
  search.addEventListener('input', ()=>{
    const q = search.value.trim();
    if(q===''){ renderPlayers(''); return; }
    const dateFromInput = parseDateFromString(q);
    if(dateFromInput){
      showView('matches'); renderMatches(); highlightMatchesByDate(dateFromInput);
    } else {
      showView('players'); renderPlayers(q);
    }
  });
  function parseDateFromString(s){
    s = s.trim();
    const iso = /^\d{4}-\d{2}-\d{2}$/;
    if(iso.test(s)) return new Date(s + 'T00:00:00');
    const dmy = /^(\d{1,2})[\/\.-](\d{1,2})[\/\.-](\d{4})$/;
    const m = s.match(dmy);
    if(m){
      const day = Number(m[1]), month=Number(m[2]), year=Number(m[3]);
      const dt = new Date(year, month-1, day);
      if(!isNaN(dt)) return dt;
    }
    return null;
  }
  function highlightMatchesByDate(date){
    const d = new Date(date); d.setHours(0,0,0,0);
    const rows = matchesTable.querySelectorAll('tr');
    rows.forEach(r=> r.style.background='transparent');
    const matches = loadMatches().sort((a,b)=> new Date(b.date) - new Date(a.date));
    matches.forEach((m, idx)=>{
      const row = matchesTable.children[idx];
      if(!row) return;
      const md = new Date(m.date); md.setHours(0,0,0,0);
      if(md.getTime() === d.getTime()){
        row.style.background = 'linear-gradient(90deg, rgba(255,59,59,0.06), transparent)';
      }
    });
  }

  // calendar
  function renderCalendar(){
    const matches = loadMatches().sort((a,b)=> new Date(a.date) - new Date(b.date));
    calendarList.innerHTML = matches.map(m=>`<div style="padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);margin-bottom:8px">
      <div style="display:flex;justify-content:space-between"><div><b>${escapeHTML(m.title)}</b><div class="muted-small">${new Date(m.date).toLocaleDateString()}</div></div><div>${(m.formations||[]).map(f=>escapeHTML(f.teamName)).join(' ‚Ä¢ ')}</div></div>
    </div>`).join('') || '<div class="muted-small">Nessuna partita</div>';
  }

  // --- PATCHED renderAdmin() - ripristina pannello admin completo ma chiede PIN quando occorre
  function renderAdmin(){
    const view = document.getElementById('viewAdmin');
    if(!view) return;

    // Render Admin panel sempre visibile; i controlli che cambiano dati richiederanno PIN al click se non sei loggato.
    const meta = getMeta();
    view.innerHTML = `<h2>Admin</h2><div class="muted-small">Pannello amministrativo</div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">
        <button id="adminAddPlayer" class="btn">Aggiungi giocatore</button>
        <button id="adminAddMatch" class="btn">Aggiungi partita</button>
        <button id="adminImport" class="btn ghost">Importa JSON</button>
        <button id="adminExport" class="btn ghost">Esporta JSON</button>
        <button id="adminExportCSV" class="btn ghost">Esporta CSV</button>
        <button id="adminEditLeague" class="btn ghost">Logo / Titolo lega</button>
        <button id="adminChangePin" class="btn ghost">Cambia PIN</button>
        <button id="adminLoginBtn" class="btn ghost">${adminModeLocal ? 'Sei admin (disconnetti)' : 'Accedi come admin'}</button>
      </div>
      <div style="margin-top:12px" class="muted-small">
        Nota: tutte le funzioni admin sono qui. Se non sei loggato, alcune azioni chiederanno il PIN al momento dell'uso.
      </div>
      <div style="margin-top:10px;font-size:13px;color:var(--muted)">PIN attuale: <strong id="adminPinDisplay">${escapeHTML(String(getAdmin().pin || '2209'))}</strong></div>
    `;

    // handlers (attach after DOM is in place)
    setTimeout(()=>{
      const requireAuth = async (fn) => {
        // if already admin, call
        if(adminModeLocal) { try{ await fn(); } catch(e){ console.error(e); } return; }
        // otherwise ask PIN
        const ok = adminPrompt();
        if(ok){
          try{ await fn(); } catch(e){ console.error(e); }
        }
      };

      document.getElementById('adminAddPlayer').addEventListener('click', ()=> {
        requireAuth(()=> openAddPlayerModal());
      });
      document.getElementById('adminAddMatch').addEventListener('click', ()=> {
        requireAuth(()=> openAddMatchModal());
      });
      document.getElementById('adminExport').addEventListener('click', ()=> exportJSON());
      document.getElementById('adminImport').addEventListener('click', ()=> {
        requireAuth(()=> {
          const ta = document.createElement('input'); ta.type='file'; ta.accept='application/json';
          ta.onchange = e=>{ const f=e.target.files[0]; if(f) importJSONFromFile(f); }; ta.click();
        });
      });
      document.getElementById('adminExportCSV').addEventListener('click', ()=> {
        const players = loadPlayers();
        const rows = [['id','firstName','lastName','birthYear','position','avgVote','goals','assists','played','mvps']];
        players.forEach(p=>{
          const s = computePlayerStats(p.id); const avg = isNaN(calcPlayerAvg(p.id))?'':calcPlayerAvg(p.id).toFixed(2);
          rows.push([p.id,p.firstName,p.lastName,p.birthYear,p.position || '', avg, s.goals, s.assists, s.played, s.mvps]);
        });
        const csv = rows.map(r=> r.map(cell=>`"${String(cell).replace(/"/g,'""')}"`).join(',')).join('\n');
        const blob = new Blob([csv], {type:'text/csv'}); const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = 'players.csv'; a.click();
      });

      document.getElementById('adminEditLeague').addEventListener('click', ()=> {
        requireAuth(()=> {
          const meta = getMeta();
          openModal(`<div class="close-x" title="Chiudi" onclick="closeModal()">‚úï</div><h3>Impostazioni Lega</h3>
            <form id="leagueForm" class="row">
              <input name="title" value="${escapeHTML(meta.leagueTitle||'SALESIAN LEAGUE')}" placeholder="Titolo lega" required />
              <div style="width:100%"><label class="kv">Logo (png/jpg)</label><input id="leagueLogoFile" name="logo" type="file" accept="image/*" /><img id="leagueLogoPreview" style="width:86px;height:86px;border-radius:12px;display:${meta.leagueLogo?'block':'none'};object-fit:cover;margin-top:6px" src="${meta.leagueLogo||''}" /></div>
              <div style="margin-left:auto"><button class="btn" type="submit">Salva</button></div>
            </form>`);
          const logoFile = document.getElementById('leagueLogoFile');
          const preview = document.getElementById('leagueLogoPreview');
          logoFile.addEventListener('change', e=>{
            const f = e.target.files[0];
            if(!f) return;
            const r = new FileReader();
            r.onload = ev=>{ preview.src = ev.target.result; preview.style.display='block'; };
            r.readAsDataURL(f);
          });
          document.getElementById('leagueForm').addEventListener('submit', (ev)=>{ ev.preventDefault(); const fd = new FormData(ev.target); const newMeta = getMeta(); newMeta.leagueTitle = fd.get('title'); const f = logoFile.files[0]; if(f){ const r=new FileReader(); r.onload = e2=>{ newMeta.leagueLogo = e2.target.result; saveMeta(newMeta).then(()=>{ renderLeagueMeta(); closeModal(); alert('Impostazioni lega salvate'); writeAdminLog('meta_update','Logo/Titolo'); renderAdmin(); }); }; r.readAsDataURL(f); } else { saveMeta(newMeta).then(()=>{ renderLeagueMeta(); closeModal(); alert('Impostazioni lega salvate'); writeAdminLog('meta_update','Titolo salvato'); renderAdmin(); }); } });
        });
      });

      document.getElementById('adminChangePin').addEventListener('click', ()=> {
        requireAuth(async ()=> {
          const newPin = prompt('Inserisci nuovo PIN admin (numerico):');
          if(!newPin) return;
          const adm = getAdmin(); adm.pin = String(newPin);
          await saveAdmin(adm);
          alert('PIN aggiornato');
          writeAdminLog('admin_pin_change','PIN cambiato');
          // update displayed pin
          const disp = document.getElementById('adminPinDisplay'); if(disp) disp.textContent = escapeHTML(String(adm.pin));
        });
      });

      document.getElementById('adminLoginBtn').addEventListener('click', ()=>{
        if(adminModeLocal){
          // logout
          adminModeLocal = false; window.adminMode = adminModeLocal;
          if(pinLabel) pinLabel.textContent = '****';
          alert('Admin disconnesso');
          renderAdmin();
        } else {
          // login
          const ok = adminPrompt();
          if(ok){
            renderAdmin();
          }
        }
      });

    }, 20);
  }

  // admin login prompt helper (used when a non-admin clicks an admin-only action)
  function adminPrompt(){
    const adm = getAdmin();
    const pin = prompt('Inserisci PIN admin:');
    if(!pin) return false;
    if(pin===String(adm.pin || adm)){ adminModeLocal=true; window.adminMode = adminModeLocal; pinLabel.textContent='(admin)'; renderAdmin(); renderPlayers(); renderMatches(); writeAdminLog('admin_login','Login via prompt'); alert('Accesso admin OK'); return true; }
    alert('PIN errato'); return false;
  }
  // expose to global
  window.adminPrompt = adminPrompt;

  // modal open/close
  function openModal(html){
    modalContent.innerHTML = html;
    modalBack.style.display = 'flex';
    modalBack.setAttribute('aria-hidden','false');
    modalContent.scrollTop = 0;
  }
  function closeModal(){ modalBack.style.display = 'none'; modalBack.setAttribute('aria-hidden','true'); modalContent.innerHTML=''; }
  // expose globally
  window.openModal = openModal;
  window.closeModal = closeModal;

  document.getElementById('modal').addEventListener('click', e=>{ if(e.target.id==='modal') closeModal(); });

  // init UI handlers: add buttons and filters
  document.getElementById('addPlayerBtnTop').addEventListener('click', ()=> {
    if(!adminModeLocal){ if(!adminPrompt()) return; }
    openAddPlayerModal();
  });
  newMatchBtn.addEventListener('click', ()=> {
    if(!adminModeLocal){ if(!adminPrompt()) return; }
    openAddMatchModal();
  });

  roleFilter.addEventListener('change', ()=> renderPlayers(search.value||''));

  // update role filter initially
  refreshRoleFilter();

  // initial render of players/matches/calendar/admin
  updateMvpCounts();
  renderPlayers(); renderMatches(); renderCalendar(); renderAdmin();

  // expose some helpers for debugging
  window._fc = {loadPlayers, loadMatches, savePlayers, saveMatches, getAdmin, saveAdmin, updateMvpCounts, renderPlayers, renderMatches, writeAdminLog};

  // small helper functions used above (repeat definitions for closure safety)
  function calcPlayerAvg(playerId){
    const matches = loadMatches();
    let sum=0,count=0;
    matches.forEach(m=>{
      (m.formations||[]).forEach(f=>{
        (f.players||[]).forEach(pl=>{
          if(pl.playerId===playerId && pl.rating!=null && pl.rating!==''){
            sum += Number(pl.rating); count++;
          }
        })
      })
    });
    return count? sum/count : NaN;
  }

  function computeScore(m){
    const teams = (m.formations||[]).map(f=>f.teamName||'Team');
    const goalsByTeam = new Array(teams.length).fill(0);
    (m.events||[]).forEach(ev=>{
      if((ev.type==='goal' || ev.type==='penalty') && typeof ev.teamIndex === 'number') goalsByTeam[ev.teamIndex] = (goalsByTeam[ev.teamIndex]||0)+1;
    });
    if(teams.length>0) return teams.map((t,i)=>goalsByTeam[i]||0).join(' - ');
    return m.score || '-';
  }

  // Rankings rendering
  function renderRankings(){
    const players = loadPlayers();
    const matches = loadMatches();
    const stats = {};
    players.forEach(p=> stats[p.id] = { player: p, goals:0, assists:0, mvps: p.mvpCount || 0 } );
    matches.forEach(m=>{
      (m.events||[]).forEach(ev=>{
        if(ev.type === 'goal' || ev.type === 'penalty'){
          if(ev.playerId && stats[ev.playerId]) stats[ev.playerId].goals++;
        }
        if(ev.type === 'assist'){
          if(ev.playerId && stats[ev.playerId]) stats[ev.playerId].assists++;
        }
        if(ev.type === 'mvp'){
          if(ev.playerId && stats[ev.playerId]) stats[ev.playerId].mvps++;
        }
      });
    });
    const byGoals = Object.values(stats).sort((a,b)=> b.goals - a.goals).slice(0,10);
    const byAssists = Object.values(stats).sort((a,b)=> b.assists - a.assists).slice(0,10);
    const byMvps = Object.values(stats).sort((a,b)=> b.mvps - a.mvps).slice(0,10);

    const elGoals = document.getElementById('rankingGoals');
    const elAssists = document.getElementById('rankingAssists');
    const elMvps = document.getElementById('rankingMvp');
    elGoals.innerHTML = byGoals.map(s=>`<div style="padding:6px;border-radius:6px;background:rgba(0,0,0,0.2);margin-bottom:6px">${escapeHTML(s.player.firstName+' '+s.player.lastName)} ‚Äî ${s.goals} goal</div>`).join('') || '<div class="muted-small">Nessun dato</div>';
    elAssists.innerHTML = byAssists.map(s=>`<div style="padding:6px;border-radius:6px;background:rgba(0,0,0,0.2);margin-bottom:6px">${escapeHTML(s.player.firstName+' '+s.player.lastName)} ‚Äî ${s.assists} assist</div>`).join('') || '<div class="muted-small">Nessun dato</div>';
    elMvps.innerHTML = byMvps.map(s=>`<div style="padding:6px;border-radius:6px;background:rgba(0,0,0,0.2);margin-bottom:6px">${escapeHTML(s.player.firstName+' '+s.player.lastName)} ‚Äî ${s.mvps} mvp</div>`).join('') || '<div class="muted-small">Nessun dato</div>';
  }

  // END DOMContentLoaded
});
</script>

<!-- Robust nav binding: directly toggle views and call renderers when available.
     Paste this just before </body>. This solves nav buttons that click but don't change view. -->
<script>
(function(){
  const viewMap = {
    players: 'viewPlayers',
    matches: 'viewMatches',
    calendar: 'viewCalendar',
    rankings: 'viewRankings',
    admin: 'viewAdmin'
  };

  function goToView(name){
    // hide all
    Object.values(viewMap).forEach(id => {
      const el = document.getElementById(id);
      if(el) el.style.display = 'none';
    });
    // show target
    const id = viewMap[name];
    const target = document.getElementById(id);
    if(target) target.style.display = 'block';

    // update active class on nav
    document.querySelectorAll('#nav button').forEach(b => b.classList.toggle('active', b.dataset.view === name));

    // call render functions if present
    try { if(name === 'players' && typeof renderPlayers === 'function') renderPlayers(document.getElementById('search')?.value || ''); } catch(e){ console.warn('renderPlayers error', e); }
    try { if(name === 'matches' && typeof renderMatches === 'function') renderMatches(); } catch(e){ console.warn('renderMatches error', e); }
    try { if(name === 'calendar' && typeof renderCalendar === 'function') renderCalendar(); } catch(e){ console.warn('renderCalendar error', e); }
    try { if(name === 'rankings' && typeof renderRankings === 'function') renderRankings(); } catch(e){ console.warn('renderRankings error', e); }
    try { if(name === 'admin' && typeof renderAdmin === 'function') renderAdmin(); } catch(e){ console.warn('renderAdmin error', e); }

    // set focus for accessibility
    if(target) target.setAttribute('tabindex','-1'), target.focus();
  }

  // attach handlers to nav buttons
  document.querySelectorAll('#nav button').forEach(btn=>{
    btn.removeEventListener('click', btn._salesian_nav_handler); // remove previous if any
    const handler = (e)=>{
      e.preventDefault();
      const v = btn.dataset.view;
      if(!v) return;
      goToView(v);
    };
    btn._salesian_nav_handler = handler;
    btn.addEventListener('click', handler);
  });

  // ensure top buttons also work (defensive)
  const addPlayerBtnTop = document.getElementById('addPlayerBtnTop');
  if(addPlayerBtnTop){
    addPlayerBtnTop.removeEventListener('click', addPlayerBtnTop._salesian_add_handler);
    addPlayerBtnTop._salesian_add_handler = function(e){
      e.preventDefault();
      // prefer existing modal function if available
      if(typeof openAddPlayerModal === 'function'){ 
        // ensure admin or prompt
        if(typeof adminMode !== 'undefined' && !adminMode && typeof adminPrompt === 'function'){ if(!adminPrompt()) return; }
        openAddPlayerModal();
      } else {
        // fallback: try to show players view
        goToView('players');
        alert('Funzione aggiungi giocatore non disponibile in questo contesto.');
      }
    };
    addPlayerBtnTop.addEventListener('click', addPlayerBtnTop._salesian_add_handler);
  }

  const newMatchBtn = document.getElementById('newMatchBtn');
  if(newMatchBtn){
    newMatchBtn.removeEventListener('click', newMatchBtn._salesian_match_handler);
    newMatchBtn._salesian_match_handler = function(e){
      e.preventDefault();
      if(typeof openAddMatchModal === 'function'){
        if(typeof adminMode !== 'undefined' && !adminMode && typeof adminPrompt === 'function'){ if(!adminPrompt()) return; }
        openAddMatchModal();
      } else {
        goToView('matches');
        alert('Funzione nuova partita non disponibile in questo contesto.');
      }
    };
    newMatchBtn.addEventListener('click', newMatchBtn._salesian_match_handler);
  }

  // If URL hash like #matches is present, open it
  const hash = (location.hash || '').replace('#','');
  if(hash && viewMap[hash]) setTimeout(()=>goToView(hash), 50);

  // ensure initial view (if none visible) is players
  setTimeout(()=>{
    const anyVisible = Object.values(viewMap).some(id=>{
      const el = document.getElementById(id);
      return el && el.style.display !== 'none';
    });
    if(!anyVisible) goToView('players');
  }, 60);

})();
</script>

</body>
</html>