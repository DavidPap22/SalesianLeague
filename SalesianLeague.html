<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#ff3b3b" />
  <title>Salesian League ‚Äî Gestione</title>
  <style>
:root{
  --bg:#0b0b0d;
  --card: rgba(255,255,255,0.06);
  --glass: rgba(255,255,255,0.06);
  --muted: rgba(255,255,255,0.6);
  --text:#ffffff;
  --accent:#ff3b3b;
  --accent-2:#ff6b6b;
  --glass-border: rgba(255,255,255,0.08);
  --glow: 0 10px 60px rgba(255,59,59,0.14);
  --radius:14px;
  --max-width:1200px;
  --btn-radius:12px;
  --btn-padding:10px 14px;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:linear-gradient(180deg,#050507 0%,#081018 65%);color:var(--text);font-family:Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;}
.wrap{min-height:100vh;display:flex;align-items:flex-start;justify-content:center;padding:18px;background:var(--bg)}
.app{width:100%;max-width:var(--max-width);display:grid;grid-template-columns:1fr;gap:14px}

/* header with logo */
header.appbar{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:8px;padding:14px;border-radius:12px;background:linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border:1px solid var(--glass-border);backdrop-filter: blur(6px);box-shadow: var(--glow)}
.league-logo{width:86px;height:86px;border-radius:12px;overflow:hidden;display:grid;place-items:center;background:linear-gradient(135deg,#ffffff10,var(--accent));border:1px solid rgba(255,255,255,0.04)}
.brand h1{margin:0;font-size:20px;letter-spacing:0.6px;font-weight:800}

/* buttons */
.btn{
  background:linear-gradient(180deg,var(--accent),var(--accent-2));
  border:0;color:white;padding:var(--btn-padding);border-radius:var(--btn-radius);cursor:pointer;font-weight:700;box-shadow:0 10px 30px rgba(255,59,59,0.12);transition:transform .14s ease, box-shadow .14s;
  display:inline-flex;align-items:center;gap:8px;
}
.btn:active{transform:translateY(1px)}
.btn.ghost{background:transparent;border:1px solid var(--glass-border);box-shadow:none;color:var(--text)}
.btn.small{padding:6px 8px;font-size:13px;border-radius:10px}
.icon-btn{width:42px;height:42px;display:inline-grid;place-items:center;border-radius:10px;background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent);border:1px solid var(--glass-border);cursor:pointer}

/* layout */
.main{display:grid;grid-template-columns:320px 1fr;gap:16px;margin-top:6px}
@media (max-width:980px){ .main{grid-template-columns:1fr} }

aside.sidebar{padding:14px;border-radius:var(--radius);background:var(--card);border:1px solid var(--glass-border);min-height:320px}
.nav{display:flex;flex-direction:column;gap:8px;margin-top:8px}
.nav button{display:flex;align-items:center;gap:10px;padding:10px;border-radius:10px;background:transparent;border:0;color:var(--muted);cursor:pointer;transition:all .18s}
.nav button.active{background:linear-gradient(90deg, rgba(255,59,59,0.08), rgba(255,59,59,0.03));color:var(--text);box-shadow:inset 0 1px 0 rgba(255,255,255,0.02)}
.search{margin-top:12px;display:flex;gap:8px}
.search input{flex:1;padding:10px;border-radius:10px;background:transparent;border:1px solid var(--glass-border);color:var(--text)}
.small-muted{font-size:13px;color:var(--muted);margin-top:10px}

/* role filter readability - ensure selected text readable */
.role-wrap{margin-top:12px}
.role-wrap select{width:100%;margin-top:6px;padding:8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)}
.role-wrap select.value-selected{color:var(--text);font-weight:700}
.role-wrap select.empty-value{color:var(--muted);font-weight:400}

/* content */
section.content{padding:14px;border-radius:var(--radius);background:var(--card);border:1px solid var(--glass-border);min-height:480px}
.grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
@media (max-width:680px){ .grid{grid-template-columns:1fr} }

/* player card */
.player{display:flex;align-items:center;padding:12px;border-radius:12px;background:linear-gradient(135deg, rgba(255,255,255,0.01), transparent);border:1px solid rgba(255,255,255,0.02);transition:transform .16s ease, box-shadow .16s ease;cursor:pointer}
.player:hover{transform:translateY(-6px);box-shadow:0 18px 40px rgba(0,0,0,0.6)}
.avatar{width:64px;height:64px;border-radius:12px;display:grid;place-items:center;font-weight:700;font-size:20px;background:linear-gradient(135deg,#ffffff10,var(--accent));border:1px solid rgba(255,255,255,0.04);object-fit:cover;overflow:hidden}
.avatar img{width:100%;height:100%;object-fit:cover;display:block}
.p-meta{flex:1;padding-left:12px}
.p-meta b{display:block;font-size:16px}
.p-meta .muted{font-size:13px;color:var(--muted)}
.p-stats{display:flex;gap:8px;align-items:center}
.chip{padding:6px 10px;border-radius:999px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03);font-weight:600}

/* table */
.table-wrap{overflow:auto;border-radius:8px}
table{width:100%;border-collapse:collapse;font-size:14px}
th,td{padding:10px;text-align:left;border-bottom:1px solid rgba(255,255,255,0.03);color:var(--muted)}
th{font-weight:700;color:var(--muted);font-size:13px}
tr:hover td{background:linear-gradient(90deg, rgba(255,255,255,0.01), transparent)}

/* modal */
.modal-back{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(2,6,23,0.75);z-index:120;padding:20px}
.modal{width:920px;max-width:100%;border-radius:14px;padding:18px;background:linear-gradient(180deg, rgba(10,10,12,0.98), rgba(12,12,16,0.98));border:1px solid rgba(255,255,255,0.06);box-shadow:0 30px 90px rgba(0,0,0,0.8);max-height:80vh;overflow:auto;position:relative}
.modal .close-x{position:absolute;right:12px;top:12px;width:36px;height:36px;border-radius:8px;display:grid;place-items:center;cursor:pointer;background:transparent;border:1px solid rgba(255,255,255,0.04)}
.modal .close-x:hover{background:rgba(255,255,255,0.02)}
form.row{display:flex;gap:8px;flex-wrap:wrap}
input,select,textarea{padding:10px;border-radius:10px;background:transparent;border:1px solid var(--glass-border);color:var(--text);min-width:0}
textarea{min-height:92px}
.hover-glow:hover{box-shadow:0 12px 40px rgba(255,59,59,0.12);transform:translateY(-4px)}
.muted-small{font-size:12px;color:var(--muted)}
.kv{font-weight:700;color:var(--muted);font-size:13px;margin-top:8px}
.small-pill{padding:6px 8px;border-radius:8px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03);font-size:13px}
.form-row{display:flex;gap:8px;align-items:center}
.event-row{display:flex;gap:8px;align-items:center;margin-bottom:8px}
.event-row input, .event-row select{padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.06)}
.logo-thumb{width:36px;height:36px;border-radius:6px;object-fit:cover;border:1px solid rgba(255,255,255,0.04)}
.player-photo-preview{width:80px;height:80px;border-radius:10px;object-fit:cover;border:1px solid rgba(255,255,255,0.04);display:block;margin-top:6px}
.footer-note{margin-top:8px;font-size:13px;color:var(--muted)}

/* ensures readability */
.modal select, .modal input, .modal textarea, .event-row select, .event-row input {
  background: rgba(0,0,0,0.6) !important;
  color: var(--text) !important;
  border: 1px solid rgba(255,255,255,0.06) !important;
}

/* focus */
button:focus,input:focus,select:focus,textarea:focus{outline:2px solid rgba(255,59,59,0.18);outline-offset:2px}
@media (max-width:480px){
  .avatar{width:56px;height:56px}
  .player-photo-preview{width:64px;height:64px}
}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="app" role="application" aria-label="Salesian League gestionale">
      <!-- Top -->
      <header class="appbar" role="banner" id="headerBar">
        <div id="leagueLogoWrap">
          <!-- logo rendered by JS -->
        </div>
        <div class="brand">
          <h1 id="leagueTitle">SALESIAN LEAGUE</h1>
        </div>
      </header>

      <!-- Main area -->
      <div class="main" style="width:100%">
        <!-- Sidebar -->
        <aside class="sidebar" aria-label="Barra laterale">
          <div style="display:flex;align-items:center;justify-content:space-between">
            <div class="small-muted">Visualizzazioni</div>
            <div class="muted-small">Pin: <span id="pinLabel">****</span></div>
          </div>

          <nav class="nav" id="nav" aria-label="Seleziona vista">
            <button class="active" data-view="players">Giocatori</button>
            <button data-view="matches">Partite</button>
            <button data-view="calendar">Calendario</button>
            <button data-view="rankings">Classifiche</button>
            <button data-view="admin">Admin</button>
          </nav>

          <div class="search" style="margin-top:10px">
            <input id="search" placeholder="Cerca: nome, cognome o data (es. 27/11/2025)" aria-label="Cerca" />
            <button id="importBtn" class="btn ghost small" title="Importa JSON">üìÅ</button>
          </div>

          <div class="role-wrap">
            <label class="kv">Filtra per ruolo</label>
            <select id="roleFilter" class="empty-value" aria-label="Filtra per ruolo">
              <option value="">Tutti</option>
            </select>
          </div>
        </aside>

        <!-- Content -->
        <section class="content" id="mainContent" aria-live="polite">
          <!-- Players view -->
          <div id="viewPlayers" class="view">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
              <div>
                <h2 style="margin:0">Giocatori</h2>
                <div class="muted-small">Visualizza, modifica e consulta la cronologia</div>
              </div>
              <div style="display:flex;gap:8px;align-items:center">
                <div class="muted-small">Totale: <span id="totalPlayers">0</span></div>
                <button id="addPlayerBtnTop" class="btn small">+ Giocatore</button>
              </div>
            </div>

            <div class="grid" id="playersGrid" aria-label="Elenco giocatori"></div>
          </div>

          <!-- Matches view -->
          <div id="viewMatches" class="view" style="display:none">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
              <div>
                <h2 style="margin:0">Partite</h2>
                <div class="muted-small">Storico partite, risultati e formazioni</div>
              </div>
              <div>
                <button id="newMatchBtn" class="btn">+ Nuova partita</button>
              </div>
            </div>

            <div class="table-wrap card" style="padding:8px;border-radius:12px;background:transparent;border:0">
              <table aria-label="Tabella partite">
                <thead><tr><th>Data</th><th>Titolo</th><th>Risultato</th><th>Azioni</th></tr></thead>
                <tbody id="matchesTable"></tbody>
              </table>
            </div>
          </div>

          <!-- Calendar view -->
          <div id="viewCalendar" class="view" style="display:none">
            <h2>Calendario</h2>
            <div id="calendarList"></div>
          </div>

          <!-- Rankings view -->
          <div id="viewRankings" class="view" style="display:none">
            <h2>Classifiche</h2>
            <div class="muted-small">Classifiche giocatori per Goal, Assist e MVP</div>
            <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:12px" id="rankingsGrid">
              <div style="padding:12px;border-radius:10px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03)"><h3>Goal</h3><div id="rankGoals"></div></div>
              <div style="padding:12px;border-radius:10px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03)"><h3>Assist</h3><div id="rankAssists"></div></div>
              <div style="padding:12px;border-radius:10px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03)"><h3>MVP</h3><div id="rankMvps"></div></div>
            </div>
          </div>

          <!-- Admin view -->
          <div id="viewAdmin" class="view" style="display:none"></div>

          <footer class="footer-note">Design moderno ‚Ä¢ Ottimizzato per mobile</footer>
        </section>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div id="modal" class="modal-back" role="dialog" aria-hidden="true">
    <div class="modal" id="modalContent" tabindex="-1"></div>
  </div>

<script>
/* ------------------------------------------------------------------
   Salesian League ‚Äî versione con PIN semplice (default 2209) e bottone
   per cambiare PIN. Tutte le funzioni principali (MVP unico, penalty,
   ranking, import/export, audit log) sono mantenute.
   ------------------------------------------------------------------ */

document.addEventListener('DOMContentLoaded', ()=>{

  /* ---------- Keys & defaults ---------- */
  const LS_PLAYERS = 'fc_players_v5';
  const LS_MATCHES = 'fc_matches_v5';
  const LS_META = 'fc_meta_v1';
  const LS_ADMIN_LOG = 'fc_admin_log_v1';
  const LS_PIN_OVERRIDE = 'fc_admin_simple_v1'; // stores { pin: 'xxxx' } if user changes PIN

  // Default PIN hardcoded in code
  const DEFAULT_ADMIN_PIN = '2209';

  const uid = ()=>Math.random().toString(36).slice(2,9);

  /* ---------- admin audit log ---------- */
  function logAdmin(action, details){
    try{
      const logs = JSON.parse(localStorage.getItem(LS_ADMIN_LOG) || '[]');
      logs.unshift({ts: new Date().toISOString(), action, details});
      while(logs.length>200) logs.pop();
      localStorage.setItem(LS_ADMIN_LOG, JSON.stringify(logs));
    }catch(e){
      console.error('logAdmin error', e);
    }
  }

  /* ---------- seed data ---------- */
  function seedIfEmpty(){
    if(!localStorage.getItem(LS_PLAYERS)){
      const demo=[];
      const roles = ['Portiere','Difensore','Centrocampista','Attaccante','Esterno'];
      const yearNow = new Date().getFullYear();
      for(let i=1;i<=12;i++){
        demo.push({
          id:uid(),
          firstName:'Nome'+i,
          lastName:'Cognome'+i,
          birthYear: yearNow - (14 + (i%6)),
          position: roles[i%roles.length],
          ratings: {velocita: Math.round(Math.random()*7)+3, fisico: Math.round(Math.random()*7)+3, tecnica: Math.round(Math.random()*7)+3},
          photo: '',
          mvpCount: 0
        });
      }
      localStorage.setItem(LS_PLAYERS, JSON.stringify(demo));
    }
    if(!localStorage.getItem(LS_MATCHES)) localStorage.setItem(LS_MATCHES, JSON.stringify([]));
    if(!localStorage.getItem(LS_META)) localStorage.setItem(LS_META, JSON.stringify({leagueTitle:'SALESIAN LEAGUE', leagueLogo: ''}));
    // no auto-saving of PIN override here; default PIN remains DEFAULT_ADMIN_PIN unless override saved by user
  }
  seedIfEmpty();

  /* ---------- storage helpers ---------- */
  const loadPlayers = ()=> JSON.parse(localStorage.getItem(LS_PLAYERS) || '[]');
  const savePlayers = (arr)=> localStorage.setItem(LS_PLAYERS, JSON.stringify(arr));
  const loadMatches = ()=> JSON.parse(localStorage.getItem(LS_MATCHES) || '[]');
  const saveMatches = (arr)=> localStorage.setItem(LS_MATCHES, JSON.stringify(arr));
  const getMeta = ()=> JSON.parse(localStorage.getItem(LS_META) || '{}');
  const saveMeta = (m)=> localStorage.setItem(LS_META, JSON.stringify(m));

  // PIN override helpers
  function getEffectivePin(){
    try{
      const o = JSON.parse(localStorage.getItem(LS_PIN_OVERRIDE) || '{}');
      if(o && o.pin) return String(o.pin);
    }catch(e){}
    return DEFAULT_ADMIN_PIN;
  }
  function setPinOverride(newPin){
    localStorage.setItem(LS_PIN_OVERRIDE, JSON.stringify({pin: String(newPin)}));
    logAdmin('pin_changed', `Pin changed to new override`);
  }
  function removePinOverride(){
    localStorage.removeItem(LS_PIN_OVERRIDE);
    logAdmin('pin_reset', `Pin override removed`);
  }

  /* ---------- UI refs ---------- */
  const nav = document.getElementById('nav');
  const views = document.querySelectorAll('.view');
  const playersGrid = document.getElementById('playersGrid');
  const matchesTable = document.getElementById('matchesTable');
  const calendarList = document.getElementById('calendarList');
  const modalBack = document.getElementById('modal');
  const modalContent = document.getElementById('modalContent');
  const importBtn = document.getElementById('importBtn');
  const search = document.getElementById('search');
  const totalPlayersLabel = document.getElementById('totalPlayers');
  const pinLabel = document.getElementById('pinLabel');
  const newMatchBtn = document.getElementById('newMatchBtn');
  const addPlayerBtnTop = document.getElementById('addPlayerBtnTop');
  const roleFilter = document.getElementById('roleFilter');
  const leagueTitleEl = document.getElementById('leagueTitle');
  const leagueLogoWrap = document.getElementById('leagueLogoWrap');
  const rankGoals = document.getElementById('rankGoals');
  const rankAssists = document.getElementById('rankAssists');
  const rankMvps = document.getElementById('rankMvps');

  let adminMode = false;
  let lastModalTrigger = null;

  window.openModal = openModal;
  window.closeModal = closeModal;

  /* ---------- render league meta ---------- */
  function renderLeagueMeta(){
    const meta = getMeta();
    leagueTitleEl.textContent = meta.leagueTitle || 'SALESIAN LEAGUE';
    leagueLogoWrap.innerHTML = '';
    if(meta.leagueLogo){
      const d = document.createElement('div'); d.className='league-logo'; d.innerHTML = `<img src="${meta.leagueLogo}" style="width:100%;height:100%;object-fit:cover">`;
      leagueLogoWrap.appendChild(d);
    } else {
      const d = document.createElement('div'); d.className='league-logo'; d.innerHTML = `<div style="font-weight:800;color:#fff">${(meta.leagueTitle||'S').charAt(0)}</div>`;
      leagueLogoWrap.appendChild(d);
    }
  }
  renderLeagueMeta();
  if(pinLabel) pinLabel.textContent = '****';

  /* ---------- navigation ---------- */
  nav.addEventListener('click', e=>{
    if(e.target.matches('button')){
      [...nav.querySelectorAll('button')].forEach(b=>b.classList.remove('active'));
      e.target.classList.add('active');
      showView(e.target.dataset.view);
    }
  });
  function showView(name){
    views.forEach(v=>v.style.display='none');
    const el = document.getElementById('view'+capitalize(name));
    if(el) el.style.display = 'block';
    if(name==='players') renderPlayers(search.value||'');
    if(name==='matches') renderMatches();
    if(name==='calendar') renderCalendar();
    if(name==='admin') renderAdmin();
    if(name==='rankings') renderRankings();
  }
  function capitalize(s){return s? s.charAt(0).toUpperCase()+s.slice(1):''}

  /* ---------- sanitize ---------- */
  function escapeHTML(s){ if(!s && s!==0) return ''; return String(s).replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

  /* ---------- small utils ---------- */
  function ageFromBirthYear(birthYear){
    if(!birthYear) return 'N/D';
    const y = Number(birthYear);
    if(isNaN(y)) return 'N/D';
    const now = new Date().getFullYear();
    return now - y;
  }

  /* ---------- stats ---------- */
  function computePlayerStats(playerId){
    const players = loadPlayers();
    const p = players.find(x=>x.id===playerId) || {mvpCount:0};
    const matches = loadMatches();
    let goals=0, assists=0, played=0;
    matches.forEach(m=>{
      (m.formations||[]).forEach(f=>{
        (f.players||[]).forEach(pl=>{
          if(pl.playerId === playerId) played++;
        });
      });
      (m.events||[]).forEach(ev=>{
        if(ev.type === 'goal' && ev.playerId === playerId) goals++;
        if(ev.type === 'assist' && ev.playerId === playerId) assists++;
        if(ev.type === 'penalty' && ev.playerId === playerId) goals++;
      });
    });
    return {goals, assists, played, mvps: p.mvpCount || 0};
  }
  function calcPlayerAvg(playerId){
    const matches = loadMatches();
    let sum=0,count=0;
    matches.forEach(m=>{
      (m.formations||[]).forEach(f=>{
        (f.players||[]).forEach(pl=>{
          if(pl.playerId===playerId && pl.rating!=null && pl.rating!==''){
            sum += Number(pl.rating); count++;
          }
        })
      })
    });
    return count? sum/count : NaN;
  }
  function computeScore(m){
    const teams = (m.formations||[]).map(f=>f.teamName||'Team');
    const goalsByTeam = new Array(teams.length).fill(0);
    (m.events||[]).forEach(ev=>{
      if((ev.type==='goal' || ev.type==='penalty') && typeof ev.teamIndex === 'number') goalsByTeam[ev.teamIndex] = (goalsByTeam[ev.teamIndex]||0)+1;
    });
    if(teams.length>0) return teams.map((t,i)=>goalsByTeam[i]||0).join(' - ');
    return m.score || '-';
  }

  function updateMvpCounts(){
    const players = loadPlayers();
    players.forEach(p => p.mvpCount = 0);
    const matches = loadMatches();
    matches.forEach(m=>{
      const mvps = (m.events||[]).filter(ev=>ev.type==='mvp' && ev.playerId);
      if(mvps.length>0){
        const last = mvps[mvps.length-1];
        const pl = players.find(p=>p.id===last.playerId);
        if(pl) pl.mvpCount = (pl.mvpCount||0) + 1;
      }
    });
    savePlayers(players);
  }

  /* ---------- role filter ---------- */
  function refreshRoleFilter(){
    const players = loadPlayers();
    const roles = Array.from(new Set(players.map(p=>p.position).filter(Boolean)));
    roleFilter.innerHTML = '<option value="">Tutti</option>' + roles.map(r=>`<option value="${escapeHTML(r)}">${escapeHTML(r)}</option>`).join('');
    setTimeout(()=>updateRoleFilterStyle(),20);
  }
  function updateRoleFilterStyle(){
    if(!roleFilter) return;
    if(roleFilter.value){
      roleFilter.classList.remove('empty-value');
      roleFilter.classList.add('value-selected');
    } else {
      roleFilter.classList.add('empty-value');
      roleFilter.classList.remove('value-selected');
    }
  }
  roleFilter.addEventListener('change', ()=> { updateRoleFilterStyle(); renderPlayers(search.value||''); });

  /* ---------- render players ---------- */
  function renderPlayers(filter=''){
    const selectedRole = roleFilter.value || '';
    const players = loadPlayers().filter(p => {
      const q = (p.firstName+' '+p.lastName).toLowerCase();
      const matchQ = !filter || q.includes(filter.toLowerCase());
      const matchRole = !selectedRole || (p.position === selectedRole);
      return matchQ && matchRole;
    });
    if(!playersGrid) return;
    playersGrid.innerHTML='';
    if(totalPlayersLabel) totalPlayersLabel.textContent = players.length;
    players.forEach(p=>{
      const avg = calcPlayerAvg(p.id);
      const stats = computePlayerStats(p.id);
      const el = document.createElement('div');
      el.className = 'player hover-glow';
      const avatarHTML = p.photo ? `<div class="avatar"><img src="${p.photo}" alt="foto ${escapeHTML(p.firstName)}"></div>` : `<div class="avatar" aria-hidden="true">${escapeHTML((p.firstName||'').charAt(0) + (p.lastName||'').charAt(0))}</div>`;
      el.innerHTML = `
        ${avatarHTML}
        <div class="p-meta">
          <b>${escapeHTML(p.firstName)} ${escapeHTML(p.lastName)}</b>
          <div class="muted">${escapeHTML(p.position||'N/D')} ‚Ä¢ ${ageFromBirthYear(p.birthYear)} anni ‚Ä¢ <span class="muted-small">Media: ${isNaN(avg)?'-':avg.toFixed(2)}</span></div>
          <div class="muted-small kv">G:${stats.goals} ‚Ä¢ A:${stats.assists} ‚Ä¢ P:${stats.played} ‚Ä¢ MVP:${stats.mvps}</div>
        </div>
        <div style="display:flex;flex-direction:column;align-items:flex-end;gap:8px">
          <div class="p-stats"><div class="chip">${isNaN(avg)?'‚Äî':avg.toFixed(2)}</div></div>
          <div style="display:flex;gap:6px">
            <button class="btn ghost small" data-action="view" data-id="${p.id}">Apri</button>
            ${adminMode ? `<button class="btn" data-action="edit" data-id="${p.id}">Modifica</button><button class="btn ghost" data-action="delete" data-id="${p.id}">Elimina</button>` : ''}
          </div>
        </div>
      `;
      el.addEventListener('click', (ev)=>{
        const btn = ev.target.closest('button');
        if(btn){
          const act = btn.getAttribute('data-action');
          const id = btn.getAttribute('data-id');
          if(act==='view') viewPlayer(id);
          if(act==='edit') openEditPlayer(id);
          if(act==='delete') deletePlayer(id);
          return;
        }
        viewPlayer(p.id);
      });
      playersGrid.appendChild(el);
    });
    refreshRoleFilter();
  }

  /* ---------- view player ---------- */
  function viewPlayer(id){
    const p = loadPlayers().find(x=>x.id===id);
    if(!p) return alert('Giocatore non trovato');
    const matches = loadMatches().filter(m=> (m.formations||[]).some(f=> (f.players||[]).some(pl=>pl.playerId===id)));
    const avg = calcPlayerAvg(id);
    const stats = computePlayerStats(id);

    let photoHTML = p.photo ? `<img src="${p.photo}" alt="foto" style="width:110px;height:110px;border-radius:10px;object-fit:cover">` : `<div style="width:110px;height:110px;border-radius:10px;background:linear-gradient(135deg,#ffffff10,var(--accent));display:grid;place-items:center;font-weight:800;font-size:34px">${escapeHTML((p.firstName||'').charAt(0)+ (p.lastName||'').charAt(0))}</div>`;

    let html = `<div class="close-x" title="Chiudi" onclick="closeModal()">‚úï</div>`;
    html += `<div style="display:flex;gap:12px;align-items:center">
      ${photoHTML}
      <div><h3 style="margin:0">${escapeHTML(p.firstName)} ${escapeHTML(p.lastName)}</h3><div class="muted-small">Anno di nascita: ${p.birthYear || 'N/D'} ‚Ä¢ Ruolo: ${escapeHTML(p.position||'N/D')}</div>
      <div class="muted-small kv">Et√†: ${ageFromBirthYear(p.birthYear)} ‚Ä¢ Media: ${isNaN(avg)?'-':avg.toFixed(2)} ‚Ä¢ Partite: ${stats.played} ‚Ä¢ Goal: ${stats.goals} ‚Ä¢ Assist: ${stats.assists} ‚Ä¢ MVP: ${stats.mvps}</div></div>
      <div style="margin-left:auto">${adminMode?`<button class='btn' onclick="openEditPlayer('${p.id}')">Modifica</button>`:''}</div>
    </div>`;

    html += `<hr style="margin:12px 0;border:none;border-top:1px solid rgba(255,255,255,0.06)"><h4>Scheda tecnica (0-10)</h4>
      <div style="display:flex;gap:12px;flex-wrap:wrap">
        <div class="small-pill">Velocit√†: ${p.ratings?.velocita ?? '-'}</div>
        <div class="small-pill">Fisico: ${p.ratings?.fisico ?? '-'}</div>
        <div class="small-pill">Tecnica: ${p.ratings?.tecnica ?? '-'}</div>
      </div>`;

    html += `<hr style="margin:12px 0;border:none;border-top:1px solid rgba(255,255,255,0.06)"><h4>Cronologia partite</h4>`;
    if(matches.length===0) html += `<div class="muted-small">Nessuna partita registrata</div>`;
    else{
      html += `<div style="display:grid;gap:8px">`;
      matches.forEach(m=>{
        const result = computeScore(m);
        html += `<div style="padding:10px;border-radius:10px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03)">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div><b>${escapeHTML(m.title)}</b><div class="muted-small">${new Date(m.date).toLocaleDateString()}</div></div>
            <div style="text-align:right">${escapeHTML(result)}</div>
          </div>
          <div style="margin-top:8px"><button class="btn ghost small" onclick="viewMatch('${m.id}')">Vedi partita</button></div>
        </div>`;
      });
      html += `</div>`;
    }

    openModal(html);
  }
  window.viewPlayer = viewPlayer;

  /* ---------- edit player (admin) ---------- */
  function openEditPlayer(id){
    if(!adminMode) return alert('Devi essere admin per modificare');
    const p = loadPlayers().find(x=>x.id===id) || {};
    lastModalTrigger = document.activeElement;
    openModal(`<div class="close-x" title="Chiudi" onclick="closeModal()">‚úï</div><h3>Modifica Giocatore</h3>
      <form id="editPlayerForm" class="row" autocomplete="off">
        <input name="firstName" value="${escapeHTML(p.firstName||'')}" required />
        <input name="lastName" value="${escapeHTML(p.lastName||'')}" required />
        <input name="birthYear" type="number" min="1900" max="${new Date().getFullYear()}" value="${escapeHTML(p.birthYear||'')}" placeholder="Anno di nascita" required />
        <input name="position" value="${escapeHTML(p.position||'')}" placeholder="Ruolo (es: Attaccante)" />
        <div style="width:100%"><label class="kv">Scheda tecnica (0-10)</label>
          <div style="display:flex;gap:8px;margin-top:6px">
            <input name="velocita" type="number" min="0" max="10" value="${escapeHTML(p.ratings?.velocita||'')}" placeholder="Velocit√†" />
            <input name="fisico" type="number" min="0" max="10" value="${escapeHTML(p.ratings?.fisico||'')}" placeholder="Fisico" />
            <input name="tecnica" type="number" min="0" max="10" value="${escapeHTML(p.ratings?.tecnica||'')}" placeholder="Tecnica" />
          </div>
        </div>

        <div style="width:100%">
          <label class="kv">Foto giocatore (png/jpg)</label>
          <input id="playerPhotoInput" name="photo" type="file" accept="image/*" />
          <img id="playerPhotoPreview" class="player-photo-preview" src="${p.photo||''}" style="${p.photo?'display:block;':'display:none;'}" alt="preview">
          ${p.photo?'<div style="margin-top:6px"><button id="removePhotoBtn" class="btn ghost small" type="button">Rimuovi foto</button></div>':''}
        </div>

        <div style="margin-left:auto;display:flex;gap:8px">
          <button class="btn" type="submit">Salva</button>
          <button class="btn ghost" id="deletePlayerBtn" type="button">Elimina giocatore</button>
        </div>
      </form>`);

    const photoInput = document.getElementById('playerPhotoInput');
    const preview = document.getElementById('playerPhotoPreview');
    const removePhotoBtn = document.getElementById('removePhotoBtn');

    photoInput.addEventListener('change', e=>{
      const f = e.target.files[0];
      if(!f) return;
      const r = new FileReader();
      r.onload = ev=>{ preview.src = ev.target.result; preview.style.display='block'; if(!document.getElementById('removePhotoBtn')){ const btn = document.createElement('button'); btn.className='btn ghost small'; btn.id='removePhotoBtn'; btn.type='button'; btn.textContent='Rimuovi foto'; btn.addEventListener('click', ()=>{ preview.src=''; preview.style.display='none'; photoInput.value=''; }); document.querySelector('#editPlayerForm div[style*="width:100%"]').appendChild(btn);} };
      r.onerror = ()=> alert('Errore lettura immagine');
      r.readAsDataURL(f);
    });

    if(removePhotoBtn){
      removePhotoBtn.addEventListener('click', ()=>{
        preview.src=''; preview.style.display='none';
        p.photo = '';
      });
    }

    document.getElementById('editPlayerForm').addEventListener('submit', e=>{
      e.preventDefault();
      const fd = new FormData(e.target);
      p.firstName = fd.get('firstName');
      p.lastName = fd.get('lastName');
      p.birthYear = fd.get('birthYear');
      p.position = fd.get('position');
      p.ratings = {velocita: Number(fd.get('velocita')||0), fisico: Number(fd.get('fisico')||0), tecnica: Number(fd.get('tecnica')||0)};
      const file = photoInput.files[0];
      if(file){
        const reader = new FileReader();
        reader.onload = ev=>{
          p.photo = ev.target.result;
          savePlayers(loadPlayers().map(x=> x.id===p.id? p : x ));
          logAdmin('edit_player', `edited ${p.id} ${p.firstName} ${p.lastName}`);
          closeModal(); renderPlayers(); alert('Giocatore aggiornato');
        };
        reader.onerror = ()=> alert('Errore lettura immagine');
        reader.readAsDataURL(file);
      } else {
        savePlayers(loadPlayers().map(x=> x.id===p.id? p : x ));
        logAdmin('edit_player', `edited ${p.id} ${p.firstName} ${p.lastName}`);
        closeModal(); renderPlayers(); alert('Giocatore aggiornato');
      }
    });

    document.getElementById('deletePlayerBtn').addEventListener('click', ()=>{
      if(confirm('Sei sicuro di voler eliminare questo giocatore?')){ deletePlayer(p.id); }
    });
  }
  window.openEditPlayer = openEditPlayer;

  /* ---------- delete player ---------- */
  function deletePlayer(id){
    if(!adminMode) return alert('Devi essere admin per eliminare');
    if(!confirm('Eliminare il giocatore?')) return;
    let players = loadPlayers().filter(p=>p.id!==id);
    savePlayers(players);
    const matches = loadMatches();
    matches.forEach(m=>{
      (m.formations||[]).forEach(f => f.players = (f.players||[]).filter(pl => pl.playerId !== id));
      if(m.events && m.events.length){
        m.events = m.events.filter(ev => !(ev.playerId===id || ev.assistTo===id));
        const mvps = m.events.filter(ev=>ev.type==='mvp');
        if(mvps.length>1){
          const last = mvps[mvps.length-1];
          m.events = m.events.filter(ev => ev.type!=='mvp' || (ev.type==='mvp' && ev === last));
        }
      }
    });
    saveMatches(matches);
    updateMvpCounts();
    closeModal();
    renderPlayers(search.value);
    renderMatches();
    logAdmin('delete_player', `deleted ${id}`);
    alert('Giocatore eliminato');
  }
  window.deletePlayer = deletePlayer;

  /* ---------- render matches ---------- */
  function renderMatches(){
    const matches = loadMatches().sort((a,b)=> new Date(b.date) - new Date(a.date));
    if(!matchesTable) return;
    matchesTable.innerHTML = '';
    if(matches.length===0){ matchesTable.innerHTML = '<tr><td colspan="4" class="muted-small">Nessuna partita registrata</td></tr>'; return; }
    matches.forEach(m=>{
      const result = computeScore(m);
      const tr = document.createElement('tr');
      const logosHTML = (m.formations||[]).map((f,fi)=> f.teamLogo ? `<img src="${f.teamLogo}" class="logo-thumb" alt="logo">` : '').join(' ');
      tr.innerHTML = `<td>${new Date(m.date).toLocaleDateString()}</td><td>${escapeHTML(m.title)}<div style="margin-top:6px">${logosHTML}</div></td><td>${escapeHTML(result)}</td><td><button class="btn ghost small" data-action="view" data-id="${m.id}">Apri</button> ${adminMode? `<button class="btn" data-action="edit" data-id="${m.id}">Modifica</button> <button class="btn ghost" data-action="delete" data-id="${m.id}">Elimina</button>`: ''}</td>`;
      tr.addEventListener('click', ev=>{
        const btn = ev.target.closest('button');
        if(!btn) return;
        const act = btn.getAttribute('data-action');
        const id = btn.getAttribute('data-id');
        if(act==='view') viewMatch(id);
        if(act==='edit') openEditMatch(id);
        if(act==='delete') deleteMatch(id);
      });
      matchesTable.appendChild(tr);
    });
  }

  /* ---------- event row HTML ---------- */
  function singleEventRowHTML(ev, formations){
    const teamOptions = (formations.length>0) ? formations.map((f,i)=>`<option value="${i}" ${i===ev.teamIndex?'selected':''}>${escapeHTML(f.teamName||('Team '+(i+1)))}</option>`).join('') : `<option value="0">Team A</option><option value="1">Team B</option>`;
    const players = loadPlayers();
    const playersOptions = players.map(p=>`<option value="${p.id}" ${p.id===ev.playerId?'selected':''}>${escapeHTML(p.firstName+' '+p.lastName)}</option>`).join('');
    const assistOptions = `<option value="">-</option>` + playersOptions;
    const minuteVal = ev.type==='mvp' ? '' : (ev.minute||'');
    const assistDisabled = ev.type==='mvp' ? 'disabled' : '';
    const minuteDisabled = ev.type==='mvp' ? 'disabled' : '';
    return `<div class="event-row" style="padding:6px;border-radius:8px;background:rgba(255,255,255,0.01);border:1px solid rgba(255,255,255,0.03)">
      <input class="ev-minute" style="width:60px" type="number" min="0" max="120" value="${escapeHTML(minuteVal)}" placeholder="min" ${minuteDisabled}/>
      <select class="ev-type">
        <option ${ev.type==='goal'?'selected':''} value="goal">Goal</option>
        <option ${ev.type==='assist'?'selected':''} value="assist">Assist</option>
        <option ${ev.type==='own'?'selected':''} value="own">Autogol</option>
        <option ${ev.type==='yellow'?'selected':''} value="yellow">Ammonizione</option>
        <option ${ev.type==='red'?'selected':''} value="red">Espulsione</option>
        <option ${ev.type==='sub'?'selected':''} value="sub">Sostituzione</option>
        <option ${ev.type==='penalty'?'selected':''} value="penalty">Rigore</option>
        <option ${ev.type==='mvp'?'selected':''} value="mvp">MVP</option>
      </select>
      <select class="ev-team">${teamOptions}</select>
      <select class="ev-player">${playersOptions}</select>
      <select class="ev-assist" ${assistDisabled}>${assistOptions}</select>
      <button class="btn ghost small ev-remove" type="button">Rimuovi</button>
    </div>`;
  }

  /* ---------- open add match ---------- */
  function openAddMatchModal(){
    const players = loadPlayers();
    lastModalTrigger = document.activeElement;
    openModal(`<div class="close-x" title="Chiudi" onclick="closeModal()">‚úï</div><h3>Nuova Partita</h3>
      <form id="newMatchForm" class="row" autocomplete="off">
        <input name="title" placeholder="Titolo (es: Amichevole vs Torre)" required />
        <input name="date" type="date" required />
        <textarea name="notes" placeholder="Note..."></textarea>
        <div style="display:flex;gap:8px">
          <div style="flex:1"><b>Formazione A</b><input name="teamA_name" placeholder="Nome squadra A" /><input name="teamA_logo" type="file" accept="image/*" /><select id="teamA_select" multiple style="height:140px">${players.map(p=>`<option value="${p.id}">${escapeHTML(p.firstName+' '+p.lastName)}</option>`).join('')}</select></div>
          <div style="flex:1"><b>Formazione B</b><input name="teamB_name" placeholder="Nome squadra B" /><input name="teamB_logo" type="file" accept="image/*" /><select id="teamB_select" multiple style="height:140px">${players.map(p=>`<option value="${p.id}">${escapeHTML(p.firstName+' '+p.lastName)}</option>`).join('')}</select></div>
        </div>
        <div style="margin-top:8px;margin-bottom:8px">
          <label class="kv">Eventi partita (puoi aggiungere MVP da qui)</label>
          <div id="newMatchEvents" style="display:grid;gap:8px"></div>
          <div style="margin-top:6px"><button id="addEventNewMatch" class="btn ghost small" type="button">+ Aggiungi evento</button></div>
        </div>
        <div style="margin-left:auto"><button class="btn" type="submit">Crea partita</button></div>
      </form>`);

    const eventsContainer = modalContent.querySelector('#newMatchEvents');
    const addEventBtn = modalContent.querySelector('#addEventNewMatch');

    eventsContainer.insertAdjacentHTML('beforeend', singleEventRowHTML({minute:'', type:'goal', teamIndex:0, playerId:'', assistTo:''}, [{teamName:'Team A'},{teamName:'Team B'}]));

    addEventBtn.addEventListener('click', e=>{
      e.preventDefault();
      eventsContainer.insertAdjacentHTML('beforeend', singleEventRowHTML({minute:'', type:'goal', teamIndex:0, playerId:'', assistTo:''}, [{teamName:'Team A'},{teamName:'Team B'}]));
    });

    document.getElementById('newMatchForm').addEventListener('submit', async e=>{
      e.preventDefault();
      if(!adminMode){ if(!adminPrompt()) return; }
      const fd = new FormData(e.target);
      const teamA = [...document.getElementById('teamA_select').selectedOptions].map(o=>o.value);
      const teamB = [...document.getElementById('teamB_select').selectedOptions].map(o=>o.value);
      const overlap = teamA.filter(v=>teamB.includes(v));
      if(overlap.length>0){ alert('Un giocatore √® selezionato in entrambe le formazioni. Rimuovere duplicati.'); return; }
      const teamAName = fd.get('teamA_name') || 'Team A';
      const teamBName = fd.get('teamB_name') || 'Team B';

      const m = {id:uid(), title:fd.get('title'), date:fd.get('date'), notes:fd.get('notes'), formations:[
        {teamName:teamAName, players: teamA.map(pid=>({playerId:pid, position:'', rating:''})), teamLogo: ''},
        {teamName:teamBName, players: teamB.map(pid=>({playerId:pid, position:'', rating:''})), teamLogo: ''}
      ], events: []};

      const evRows = modalContent.querySelectorAll('#newMatchEvents .event-row');
      const newEvents = [];
      for(const row of evRows){
        const type = row.querySelector('.ev-type').value || 'goal';
        const teamIndex = Number(row.querySelector('.ev-team').value || 0);
        const playerId = row.querySelector('.ev-player').value || '';
        const assistTo = row.querySelector('.ev-assist') ? row.querySelector('.ev-assist').value || '' : '';
        const minuteInput = row.querySelector('.ev-minute') ? row.querySelector('.ev-minute').value || '' : '';
        if(type === 'mvp'){
          if(newEvents.some(x=>x.type==='mvp')){ alert('Esiste gi√† un MVP per questa partita'); return; }
          if(!playerId){ alert('Seleziona un giocatore per MVP'); return; }
          newEvents.push({type:'mvp', playerId: playerId, teamIndex: teamIndex, minute: null, assistTo: null});
        } else {
          const minute = minuteInput !== '' ? Number(minuteInput) : null;
          if(minute!=null && (minute < 0 || minute > 120)){ alert('Minuto non valido'); return; }
          newEvents.push({minute: minute, type, teamIndex, playerId: playerId || '', assistTo: assistTo || null});
        }
      }

      const fileA = modalContent.querySelector('[name="teamA_logo"]').files[0];
      const fileB = modalContent.querySelector('[name="teamB_logo"]').files[0];
      const promises = [];
      if(fileA){
        promises.push(new Promise((res,rej)=>{
          const r=new FileReader(); r.onload=ev=>{ m.formations[0].teamLogo = ev.target.result; res(); }; r.onerror=rej; r.readAsDataURL(fileA);
        }));
      }
      if(fileB){
        promises.push(new Promise((res,rej)=>{
          const r=new FileReader(); r.onload=ev=>{ m.formations[1].teamLogo = ev.target.result; res(); }; r.onerror=rej; r.readAsDataURL(fileB);
        }));
      }

      try{
        await Promise.all(promises);
      }catch(e){
        alert('Errore caricamento logo');
        return;
      }

      m.events = newEvents;
      const matches = loadMatches(); matches.push(m); saveMatches(matches);
      updateMvpCounts();
      logAdmin('create_match', `created ${m.id} title:${m.title}`);
      closeModal(); renderMatches(); alert('Partita creata');
    });
  }

  /* ---------- add player ---------- */
  function openAddPlayerModal(){
    lastModalTrigger = document.activeElement;
    openModal(`<div class="close-x" title="Chiudi" onclick="closeModal()">‚úï</div><h3>Nuovo Giocatore</h3><form id="newPlayerFrm" class="row"><input name="firstName" placeholder="Nome" required /><input name="lastName" placeholder="Cognome" required /><input name="birthYear" type="number" min="1900" max="${new Date().getFullYear()}" placeholder="Anno di nascita" required /><input name="position" placeholder="Ruolo" /><div style="width:100%"><label class="kv">Scheda tecnica (0-10)</label><div style="display:flex;gap:8px;margin-top:6px"><input name="velocita" type="number" min="0" max="10" placeholder="Velocit√†" /><input name="fisico" type="number" min="0" max="10" placeholder="Fisico" /><input name="tecnica" type="number" min="0" max="10" placeholder="Tecnica" /></div></div><div style="width:100%"><label class="kv">Foto giocatore (png/jpg)</label><input id="newPlayerPhoto" name="photo" type="file" accept="image/*" /><img id="newPlayerPreview" class="player-photo-preview" style="display:none"></div><div style="margin-left:auto"><button class="btn" type="submit">Crea</button></div></form>`);

    const newPhoto = document.getElementById('newPlayerPhoto');
    const preview = document.getElementById('newPlayerPreview');
    newPhoto.addEventListener('change', e=>{
      const f = e.target.files[0];
      if(!f) return;
      const r = new FileReader();
      r.onload = ev=>{ preview.src = ev.target.result; preview.style.display='block'; };
      r.onerror = ()=> alert('Errore lettura immagine');
      r.readAsDataURL(f);
    });

    document.getElementById('newPlayerFrm').addEventListener('submit', e=>{
      e.preventDefault();
      if(!adminMode){ if(!adminPrompt()) return; }
      const fd = new FormData(e.target);
      const data = {id:uid(), firstName:fd.get('firstName'), lastName:fd.get('lastName'), birthYear: fd.get('birthYear'), position:fd.get('position'), ratings:{velocita:Number(fd.get('velocita')||0), fisico:Number(fd.get('fisico')||0), tecnica:Number(fd.get('tecnica')||0)}, photo:'', mvpCount:0};
      const file = newPhoto.files[0];
      if(file){
        const r = new FileReader();
        r.onload = ev=>{ data.photo = ev.target.result; const players = loadPlayers(); players.push(data); savePlayers(players); refreshRoleFilter(); closeModal(); renderPlayers(); logAdmin('create_player', `created ${data.id} ${data.firstName}`); alert('Giocatore aggiunto'); };
        r.onerror = ()=> alert('Errore lettura immagine');
        r.readAsDataURL(file);
      } else {
        const players = loadPlayers(); players.push(data); savePlayers(players); refreshRoleFilter(); closeModal(); renderPlayers(); logAdmin('create_player', `created ${data.id} ${data.firstName}`); alert('Giocatore aggiunto');
      }
    });
  }

  /* ---------- export/import ---------- */
  function exportJSON(){
    const dump = {players: loadPlayers(), matches: loadMatches(), meta: getMeta()};
    const blob = new Blob([JSON.stringify(dump, null, 2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'salesian-league-backup.json'; a.click();
    logAdmin('export_json','exported state');
  }
  function importJSONFromFile(file){
    try{
      const backup = {players: loadPlayers(), matches: loadMatches(), meta: getMeta()};
      localStorage.setItem(LS_ADMIN_LOG + '_backup', JSON.stringify({ts:new Date().toISOString(), backup}));
    }catch(e){}
    const r = new FileReader();
    r.onload = ev => {
      try{
        const data = JSON.parse(ev.target.result);
        if(data.players) savePlayers(data.players);
        if(data.matches) saveMatches(data.matches);
        if(data.meta) saveMeta(data.meta);
        updateMvpCounts();
        renderLeagueMeta();
        renderPlayers(); renderMatches(); alert('Import completato');
        logAdmin('import_json','imported file');
      }catch(err){ alert('File non valido') }
    }; r.readAsText(file);
  }
  if(importBtn){
    importBtn.addEventListener('click', ()=>{
      const ta = document.createElement('input'); ta.type='file'; ta.accept='application/json'; ta.onchange = e=>{
        const f = e.target.files[0];
        if(f){
          if(!confirm('Import sovrascriver√† dati locali. Procedere?')) return;
          importJSONFromFile(f);
        }
      }; ta.click();
    });
  }

  /* ---------- search ---------- */
  search.addEventListener('input', ()=>{
    const q = search.value.trim();
    if(q===''){ renderPlayers(''); return; }
    const dateFromInput = parseDateFromString(q);
    if(dateFromInput){
      showView('matches'); renderMatches(); highlightMatchesByDate(dateFromInput);
    } else {
      showView('players'); renderPlayers(q);
    }
  });
  function parseDateFromString(s){
    s = s.trim();
    const iso = /^\d{4}-\d{2}-\d{2}$/;
    if(iso.test(s)) return new Date(s + 'T00:00:00');
    const dmy = /^(\d{1,2})[\/\.-](\d{1,2})[\/\.-](\d{4})$/;
    const m = s.match(dmy);
    if(m){
      const day = Number(m[1]), month=Number(m[2]), year=Number(m[3]);
      const dt = new Date(year, month-1, day);
      if(!isNaN(dt)) return dt;
    }
    return null;
  }
  function highlightMatchesByDate(date){
    const d = new Date(date); d.setHours(0,0,0,0);
    const rows = matchesTable.querySelectorAll('tr');
    rows.forEach(r=> r.style.background='transparent');
    const matches = loadMatches().sort((a,b)=> new Date(b.date) - new Date(a.date));
    matches.forEach((m, idx)=>{
      const row = matchesTable.children[idx];
      if(!row) return;
      const md = new Date(m.date); md.setHours(0,0,0,0);
      if(md.getTime() === d.getTime()){
        row.style.background = 'linear-gradient(90deg, rgba(255,59,59,0.06), transparent)';
      }
    });
  }

  /* ---------- calendar ---------- */
  function renderCalendar(){
    const matches = loadMatches().sort((a,b)=> new Date(a.date) - new Date(b.date));
    calendarList.innerHTML = matches.map(m=>`<div style="padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);margin-bottom:8px">
      <div style="display:flex;justify-content:space-between"><div><b>${escapeHTML(m.title)}</b><div class="muted-small">${new Date(m.date).toLocaleDateString()}</div></div><div>${(m.formations||[]).map(f=>escapeHTML(f.teamName)).join(' ‚Ä¢ ')}</div></div>
    </div>`).join('') || '<div class="muted-small">Nessuna partita</div>';
  }

  /* ---------- ADMIN: render & simple PIN auth ---------- */
  // effective PIN logic: use override if set, otherwise DEFAULT_ADMIN_PIN
  function renderAdmin(){
    const view = document.getElementById('viewAdmin');
    if(!view) return;
    const meta = getMeta();
    const defaultPinNotice = `<div style="margin-top:12px" class="muted-small">PIN di default: <b>${DEFAULT_ADMIN_PIN}</b> (puoi cambiarlo con il pulsante qui sotto)</div>`;

    if(!adminMode){
      view.innerHTML = `<h2>Admin</h2><div class="muted-small">Area protetta ‚Äî inserisci PIN per accedere</div>
        <form id="adminLoginInline" style="margin-top:12px;display:flex;gap:8px;align-items:center" autocomplete="off">
          <input name="pin" placeholder="PIN admin" />
          <button class="btn" type="submit">Entra</button>
        </form>
        ${defaultPinNotice}
        <div style="margin-top:12px" class="muted-small">Nota: se non ricordi il PIN puoi usare '${DEFAULT_ADMIN_PIN}' finch√© non lo cambi.</div>`;
      setTimeout(()=>{
        document.getElementById('adminLoginInline').addEventListener('submit', e=>{
          e.preventDefault();
          const pin = new FormData(e.target).get('pin');
          const effective = getEffectivePin();
          if(String(pin) === String(effective)){
            adminMode=true; if(pinLabel) pinLabel.textContent='(admin)';
            renderAdmin(); renderPlayers(); renderMatches();
            logAdmin('admin_login','inline login success');
            alert('Accesso admin OK');
          } else alert('PIN errato');
        });
      },20);
    } else {
      view.innerHTML = `<h2>Admin</h2><div class="muted-small">Pannello amministrativo</div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">
          <button id="adminAddPlayer" class="btn">Aggiungi giocatore</button>
          <button id="adminAddMatch" class="btn">Aggiungi partita</button>
          <button id="adminImport" class="btn ghost">Importa JSON</button>
          <button id="adminExport" class="btn ghost">Esporta JSON</button>
          <button id="adminExportCSV" class="btn ghost">Esporta CSV</button>
          <button id="adminEditLeague" class="btn ghost">Logo / Titolo lega</button>
          <button id="adminViewLog" class="btn ghost">Audit log</button>
          <button id="adminChangePin" class="btn ghost">Cambia PIN</button>
          <button id="adminResetPin" class="btn ghost">Ripristina PIN default</button>
          <button id="adminLogout" class="btn ghost">Logout</button>
        </div>
        ${defaultPinNotice}
        <div style="margin-top:12px" class="muted-small">Nota: tutte le funzioni admin sono qui. Le azioni di modifica/elimina appaiono anche nelle viste Giocatori/Partite.</div>`;

      setTimeout(()=>{
        document.getElementById('adminAddPlayer').addEventListener('click', ()=> openAddPlayerModal());
        document.getElementById('adminAddMatch').addEventListener('click', ()=> openAddMatchModal());
        document.getElementById('adminExport').addEventListener('click', ()=> exportJSON());
        document.getElementById('adminImport').addEventListener('click', ()=>{ const ta = document.createElement('input'); ta.type='file'; ta.accept='application/json'; ta.onchange = e=>{ const f=e.target.files[0]; if(f) importJSONFromFile(f); }; ta.click(); });
        document.getElementById('adminExportCSV').addEventListener('click', ()=> {
          const players = loadPlayers();
          const rows = [['id','firstName','lastName','birthYear','position','avgVote','goals','assists','played','mvps']];
          players.forEach(p=>{
            const s = computePlayerStats(p.id); const avg = isNaN(calcPlayerAvg(p.id))?'':(calcPlayerAvg(p.id)).toFixed(2);
            rows.push([p.id,p.firstName,p.lastName,p.birthYear,p.position || '', avg, s.goals, s.assists, s.played, s.mvps]);
          });
          const csv = rows.map(r=> r.map(cell=>`"${String(cell).replace(/"/g,'""')}"`).join(',')).join('\n');
          const blob = new Blob([csv], {type:'text/csv'}); const url = URL.createObjectURL(blob);
          const a = document.createElement('a'); a.href = url; a.download = 'players.csv'; a.click();
          logAdmin('export_csv','exported players csv');
        });
        document.getElementById('adminEditLeague').addEventListener('click', ()=> {
          const meta = getMeta();
          openModal(`<div class="close-x" title="Chiudi" onclick="closeModal()">‚úï</div><h3>Impostazioni Lega</h3>
            <form id="leagueForm" class="row">
              <input name="title" value="${escapeHTML(meta.leagueTitle||'SALESIAN LEAGUE')}" placeholder="Titolo lega" required />
              <div style="width:100%"><label class="kv">Logo (png/jpg)</label><input id="leagueLogoFile" name="logo" type="file" accept="image/*" /><img id="leagueLogoPreview" style="width:86px;height:86px;border-radius:12px;display:${meta.leagueLogo?'block':'none'};object-fit:cover;margin-top:6px" src="${meta.leagueLogo||''}" /></div>
              <div style="margin-left:auto"><button class="btn" type="submit">Salva</button></div>
            </form>`);
          const logoFile = document.getElementById('leagueLogoFile');
          const preview = document.getElementById('leagueLogoPreview');
          logoFile.addEventListener('change', e=>{
            const f = e.target.files[0];
            if(!f) return;
            const r = new FileReader();
            r.onload = ev=>{ preview.src = ev.target.result; preview.style.display='block'; };
            r.onerror = ()=> alert('Errore lettura immagine');
            r.readAsDataURL(f);
          });
          document.getElementById('leagueForm').addEventListener('submit', (ev)=>{ ev.preventDefault(); const fd = new FormData(ev.target); const newMeta = getMeta(); newMeta.leagueTitle = fd.get('title'); const f = logoFile.files[0]; if(f){ const r=new FileReader(); r.onload = e2=>{ newMeta.leagueLogo = e2.target.result; saveMeta(newMeta); renderLeagueMeta(); closeModal(); logAdmin('edit_league','edited league meta'); alert('Impostazioni lega salvate'); }; r.onerror = ()=> alert('Errore lettura immagine'); r.readAsDataURL(f); } else { saveMeta(newMeta); renderLeagueMeta(); closeModal(); logAdmin('edit_league','edited league meta'); alert('Impostazioni lega salvate'); } });
        });
        document.getElementById('adminViewLog').addEventListener('click', ()=> {
          const logs = JSON.parse(localStorage.getItem(LS_ADMIN_LOG) || '[]');
          const html = `<div class="close-x" title="Chiudi" onclick="closeModal()">‚úï</div><h3>Audit log</h3><div style="max-height:50vh;overflow:auto;padding-top:8px">${logs.map(l=>`<div style="padding:8px;border-bottom:1px solid rgba(255,255,255,0.03)"><b>${escapeHTML(l.action)}</b> <span class="muted-small"> - ${new Date(l.ts).toLocaleString()}</span><div style="font-size:13px">${escapeHTML(l.details||'')}</div></div>`).join('') || '<div class="muted-small">Nessun log</div>'}</div>`;
          openModal(html);
        });
        document.getElementById('adminChangePin').addEventListener('click', ()=> openChangePinModal());
        document.getElementById('adminResetPin').addEventListener('click', ()=>{
          if(!confirm('Ripristinare il PIN di default (2209)?')) return;
          removePinOverride();
          alert('PIN ripristinato al default');
          logAdmin('pin_reset','admin reset to default pin');
        });
        document.getElementById('adminLogout').addEventListener('click', ()=>{ adminMode=false; if(pinLabel) pinLabel.textContent='****'; renderAdmin(); renderPlayers(); renderMatches(); logAdmin('admin_logout','logout'); alert('Admin disconnesso'); });
      },20);
    }
  }

  /* ---------- adminPrompt (inline prompt fallback) ---------- */
  function adminPrompt(){
    const pin = prompt('Inserisci PIN admin:');
    if(pin === null) return false;
    const effective = getEffectivePin();
    if(String(pin) === String(effective)){ adminMode=true; if(pinLabel) pinLabel.textContent='(admin)'; renderAdmin(); renderPlayers(); renderMatches(); logAdmin('admin_login','prompt login success'); alert('Accesso admin OK'); return true; }
    alert('PIN errato'); return false;
  }

  /* ---------- openChangePinModal ---------- */
  function openChangePinModal(){
    lastModalTrigger = document.activeElement;
    openModal(`<div class="close-x" title="Chiudi" onclick="closeModal()">‚úï</div><h3>Cambia PIN admin</h3>
      <form id="changePinForm" class="row" autocomplete="off" style="gap:8px;display:flex;flex-direction:column">
        <input name="oldPin" type="password" placeholder="PIN attuale" required />
        <input name="newPin" type="password" placeholder="Nuovo PIN (es. 4 cifre)" required />
        <input name="confirmPin" type="password" placeholder="Conferma nuovo PIN" required />
        <div style="display:flex;gap:8px;justify-content:flex-end">
          <button class="btn" type="submit">Salva</button>
          <button class="btn ghost" type="button" id="cancelChangePin">Annulla</button>
        </div>
      </form>`);
    const form = document.getElementById('changePinForm');
    document.getElementById('cancelChangePin').addEventListener('click', ()=> closeModal());
    form.addEventListener('submit', (ev)=>{
      ev.preventDefault();
      const fd = new FormData(form);
      const oldPin = fd.get('oldPin') || '';
      const newPin = fd.get('newPin') || '';
      const confirmPin = fd.get('confirmPin') || '';
      if(newPin !== confirmPin){ alert('Nuovo PIN e conferma non corrispondono'); return; }
      const effective = getEffectivePin();
      if(String(oldPin) !== String(effective)){ alert('PIN attuale errato'); return; }
      // save override simply in localStorage
      setPinOverride(newPin);
      alert('PIN aggiornato correttamente');
      closeModal();
    });
  }

  /* ---------- modal open/close ---------- */
  function openModal(html){
    modalContent.innerHTML = html;
    modalBack.style.display = 'flex';
    modalBack.setAttribute('aria-hidden','false');
    modalContent.scrollTop = 0;
    setTimeout(()=>{ const first = modalContent.querySelector('input,select,textarea,button'); if(first) first.focus(); },50);
  }
  function closeModal(){ modalBack.style.display = 'none'; modalBack.setAttribute('aria-hidden','true'); modalContent.innerHTML=''; try{ if(lastModalTrigger) lastModalTrigger.focus(); }catch(e){} }
  document.getElementById('modal').addEventListener('click', e=>{ if(e.target.id==='modal') closeModal(); });

  /* ---------- init UI handlers ---------- */
  addPlayerBtnTop.addEventListener('click', ()=> {
    if(!adminMode){ if(!adminPrompt()) return; }
    openAddPlayerModal();
  });
  newMatchBtn.addEventListener('click', ()=> {
    if(!adminMode){ if(!adminPrompt()) return; }
    openAddMatchModal();
  });

  roleFilter.addEventListener('change', ()=> renderPlayers(search.value||''));

  refreshRoleFilter();

  updateMvpCounts();
  renderPlayers(); renderMatches(); renderCalendar(); renderAdmin();

  window._fc = {loadPlayers, loadMatches, savePlayers, saveMatches, updateMvpCounts, renderPlayers, renderMatches, logAdmin};

  /* ---------- rankings ---------- */
  function renderRankings(){
    const players = loadPlayers();
    const stats = players.map(p=>{
      const s = computePlayerStats(p.id);
      return {id:p.id, name: `${p.firstName} ${p.lastName}`, goals: s.goals, assists: s.assists, mvps: s.mvps};
    });
    const topGoals = stats.slice().sort((a,b)=>b.goals - a.goals).slice(0,10);
    const topAssists = stats.slice().sort((a,b)=>b.assists - a.assists).slice(0,10);
    const topMvps = stats.slice().sort((a,b)=>b.mvps - a.mvps).slice(0,10);
    rankGoals.innerHTML = topGoals.map((r,i)=>`<div style="padding:6px;border-bottom:1px solid rgba(255,255,255,0.03)">${i+1}. <b>${escapeHTML(r.name)}</b> ‚Äî ${r.goals} G</div>`).join('') || '<div class="muted-small">Nessun dato</div>';
    rankAssists.innerHTML = topAssists.map((r,i)=>`<div style="padding:6px;border-bottom:1px solid rgba(255,255,255,0.03)">${i+1}. <b>${escapeHTML(r.name)}</b> ‚Äî ${r.assists} A</div>`).join('') || '<div class="muted-small">Nessun dato</div>';
    rankMvps.innerHTML = topMvps.map((r,i)=>`<div style="padding:6px;border-bottom:1px solid rgba(255,255,255,0.03)">${i+1}. <b>${escapeHTML(r.name)}</b> ‚Äî ${r.mvps} MVP</div>`).join('') || '<div class="muted-small">Nessun dato</div>';
  }

  /* ---------- sanitize match events ---------- */
  function sanitizeMatchEvents(m){
    if(!m.events) m.events = [];
    m.events = m.events.filter(ev => {
      if(ev.type === 'mvp') return !!ev.playerId;
      if(['goal','assist','penalty','own'].includes(ev.type)) return !!ev.playerId && typeof ev.teamIndex === 'number';
      return true;
    });
    const mvps = m.events.filter(ev=>ev.type==='mvp');
    if(mvps.length>1){
      const last = mvps[mvps.length-1];
      m.events = m.events.filter(ev => ev.type!=='mvp' || (ev.type==='mvp' && ev===last));
    }
    return m;
  }

  /* ---------- edit match ---------- */
  function openEditMatch(id){
    if(!adminMode) return alert('Devi essere admin per modificare');
    const m = loadMatches().find(x=>x.id===id);
    if(!m) return alert('Partita non trovata');
    const players = loadPlayers();
    let formationsHTML = '';
    (m.formations||[]).forEach((f,fi)=>{
      formationsHTML += `<div style="padding:8px;border-radius:10px;background:rgba(255,255,255,0.01);margin-bottom:8px">
        <b>Formazione: <input name="teamName_${fi}" value="${escapeHTML(f.teamName||'')}" /></b>
        <div style="margin-top:6px;display:flex;gap:8px;align-items:center">
          <div>Logo squadra:</div>
          <input name="teamLogoFile_${fi}" type="file" accept="image/*" />
          <img id="teamLogoPreview_${fi}" class="logo-thumb" src="${f.teamLogo||''}" style="${f.teamLogo?'display:block;':'display:none;'}" alt="preview">
        </div>
        <table style="width:100%;margin-top:8px"><thead><tr><th>Giocatore</th><th>Ruolo</th><th>Voto</th><th>Rimuovi</th></tr></thead><tbody>`;
      (f.players||[]).forEach((pl,pi)=>{
        const g = players.find(pp=>pp.id===pl.playerId) || {firstName:'(rimosso)',lastName:''};
        formationsHTML += `<tr>
          <td>${escapeHTML(g.firstName)} ${escapeHTML(g.lastName)}<input type="hidden" name="playerId_${fi}_${pi}" value="${escapeHTML(pl.playerId)}"></td>
          <td><input name="position_${fi}_${pi}" value="${escapeHTML(pl.position||'')}" /></td>
          <td><input name="rating_${fi}_${pi}" value="${escapeHTML(pl.rating||'')}" /></td>
          <td><input type="checkbox" name="keep_${fi}_${pi}" checked></td>
        </tr>`;
      });
      formationsHTML += `</tbody></table></div>`;
    });

    let eventsHTML = `<div id="eventsContainer" style="display:grid;gap:8px">`;
    (m.events||[]).forEach(ev=>{
      eventsHTML += singleEventRowHTML(ev, m.formations || []);
    });
    eventsHTML += `</div><div style="margin-top:8px"><button id="addEventBtn" class="btn ghost small" type="button">+ Aggiungi evento</button></div>`;

    lastModalTrigger = document.activeElement;
    openModal(`<div class="close-x" title="Chiudi" onclick="closeModal()">‚úï</div><h3>Modifica partita</h3>
      <form id="editMatchForm" class="row" autocomplete="off">
        <input name="title" value="${escapeHTML(m.title || '')}" required />
        <input name="date" type="date" value="${new Date(m.date).toISOString().slice(0,10)}" required />
        <textarea name="notes" placeholder="Note...">${escapeHTML(m.notes||'')}</textarea>
        ${formationsHTML}
        <hr style="margin:8px 0;border:none;border-top:1px solid rgba(255,255,255,0.06)">
        <label class="kv">Eventi partita (MVP disponibile)</label>
        ${eventsHTML}
        <div style="margin-left:auto;display:flex;gap:8px">
          <button class="btn" type="submit">Salva</button>
          <button class="btn ghost" id="deleteMatchBtn" type="button">Elimina partita</button>
        </div>
      </form>`);

    (m.formations||[]).forEach((f,fi)=>{
      const fileInput = modalContent.querySelector(`[name="teamLogoFile_${fi}"]`);
      const previewImg = document.getElementById(`teamLogoPreview_${fi}`);
      if(fileInput){
        fileInput.addEventListener('change', e=>{
          const file = e.target.files[0];
          if(!file) return;
          const r = new FileReader();
          r.onload = ev=>{ previewImg.src = ev.target.result; previewImg.style.display='block'; };
          r.onerror = ()=> alert('Errore lettura immagine');
          r.readAsDataURL(file);
        });
      }
    });

    const eventsContainer = document.getElementById('eventsContainer');
    document.getElementById('addEventBtn').addEventListener('click', (e)=>{
      e.preventDefault();
      eventsContainer.insertAdjacentHTML('beforeend', singleEventRowHTML({minute:90,type:'goal',teamIndex:0,playerId:'',assistTo:''}, m.formations || []));
    });

    eventsContainer.addEventListener('click', (ev)=>{
      if(ev.target.classList.contains('ev-remove')) ev.target.closest('.event-row').remove();
    });
    eventsContainer.addEventListener('change', (ev)=>{
      const row = ev.target.closest('.event-row');
      if(!row) return;
      const typeSel = row.querySelector('.ev-type');
      const minuteInp = row.querySelector('.ev-minute');
      const assistSel = row.querySelector('.ev-assist');
      if(ev.target.classList.contains('ev-type')){
        const type = typeSel.value;
        if(type === 'mvp'){
          const existing = Array.from(eventsContainer.querySelectorAll('.event-row .ev-type')).filter(s=>s.value==='mvp');
          if(existing.length>1){
            alert('Gi√† presente un MVP per questa partita. Rimuovi l\'altro per aggiungerne uno nuovo.');
            typeSel.value = 'goal';
            minuteInp.disabled = false;
            assistSel.disabled = false;
            return;
          }
          if(minuteInp) { minuteInp.value=''; minuteInp.disabled = true; }
          if(assistSel) { assistSel.value=''; assistSel.disabled = true; }
        } else {
          if(minuteInp) minuteInp.disabled = false;
          if(assistSel) assistSel.disabled = false;
        }
      }
    });

    document.getElementById('deleteMatchBtn').addEventListener('click', ()=>{
      if(confirm('Sei sicuro di voler eliminare questa partita?')){ deleteMatch(m.id); }
    });

    document.getElementById('editMatchForm').addEventListener('submit', async e=>{
      e.preventDefault();
      const fd = new FormData(e.target);
      m.title = fd.get('title'); m.date = fd.get('date'); m.notes = fd.get('notes');

      m.formations.forEach((f,fi)=>{
        f.teamName = fd.get(`teamName_${fi}`) || f.teamName;
        const logoFileInput = modalContent.querySelector(`[name="teamLogoFile_${fi}"]`);
        if(logoFileInput && logoFileInput.files && logoFileInput.files[0]){
          function readFileAsDataURL(file){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=ev=>res(ev.target.result); r.onerror=err=>rej(err); r.readAsDataURL(file); }) }
          f._logoPromise = readFileAsDataURL(logoFileInput.files[0]);
        }
        f.players.forEach((pl,pi)=>{
          if(!fd.get(`keep_${fi}_${pi}`)) { pl._remove = true; return; }
          pl.position = fd.get(`position_${fi}_${pi}`) || pl.position;
          pl.rating = fd.get(`rating_${fi}_${pi}`) || pl.rating;
        });
        f.players = f.players.filter(p=>!p._remove);
        f.players.forEach(p=> delete p._remove );
      });

      const evRows = modalContent.querySelectorAll('.event-row');
      const newEvents = [];
      evRows.forEach(row=>{
        const minuteVal = row.querySelector('.ev-minute') ? row.querySelector('.ev-minute').value || '' : '';
        const minute = minuteVal !== '' ? Number(minuteVal) : null;
        const type = row.querySelector('.ev-type').value || 'goal';
        const teamIndex = Number(row.querySelector('.ev-team').value || 0);
        const playerId = row.querySelector('.ev-player').value || '';
        const assistTo = row.querySelector('.ev-assist') ? row.querySelector('.ev-assist').value || '' : '';
        if(type === 'mvp'){
          if(!playerId) return;
          newEvents.push({type:'mvp', playerId, teamIndex, minute:null, assistTo:null});
        } else {
          newEvents.push({minute: minute, type, teamIndex, playerId: playerId || '', assistTo: assistTo || null});
        }
      });
      m.events = newEvents;

      const logoPromises = [];
      m.formations.forEach((f)=>{
        if(f._logoPromise){ logoPromises.push(f._logoPromise.then(dataUrl=>{ f.teamLogo = dataUrl; delete f._logoPromise; })); }
      });
      await Promise.all(logoPromises);

      sanitizeMatchEvents(m);
      saveMatches(loadMatches().map(x=> x.id===m.id? m : x));
      updateMvpCounts();
      logAdmin('edit_match', `edited ${m.id} title:${m.title}`);
      closeModal(); renderMatches(); renderPlayers(); alert('Partita aggiornata');
    });
  }

}); // end DOMContentLoaded
</script>
</body>
</html>