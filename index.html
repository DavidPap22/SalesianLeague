<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#ff3b3b" />
  <title>Salesian League ‚Äî Live</title>
  <style>
/* --- CSS VARIABLES & RESET --- */
:root{
  --bg:#0b0b0d;
  --card: rgba(255,255,255,0.06);
  --glass: rgba(255,255,255,0.06);
  --muted: rgba(255,255,255,0.6);
  --text:#ffffff;
  --accent:#ff3b3b;
  --accent-2:#ff6b6b;
  --glass-border: rgba(255,255,255,0.08);
  --glow: 0 10px 60px rgba(255,59,59,0.14);
  --radius:14px;
  --max-width:1200px;
  --btn-radius:12px;
  --btn-padding:10px 14px;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:linear-gradient(180deg,#050507 0%,#081018 65%);color:var(--text);font-family:Inter, ui-sans-serif, system-ui, -apple-system, sans-serif;}
.wrap{min-height:100vh;display:flex;align-items:flex-start;justify-content:center;padding:18px;background:var(--bg)}
.app{width:100%;max-width:var(--max-width);display:grid;grid-template-columns:1fr;gap:14px}

/* HEADER */
header.appbar{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:8px;padding:14px;border-radius:12px;background:linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border:1px solid var(--glass-border);backdrop-filter: blur(6px);box-shadow: var(--glow)}
.league-logo{width:86px;height:86px;border-radius:12px;overflow:hidden;display:grid;place-items:center;background:linear-gradient(135deg,#ffffff10,var(--accent));border:1px solid rgba(255,255,255,0.04)}
.brand h1{margin:0;font-size:20px;letter-spacing:0.6px;font-weight:800}

/* BUTTONS */
.btn{
  background:linear-gradient(180deg,var(--accent),var(--accent-2));
  border:0;color:white;padding:var(--btn-padding);border-radius:var(--btn-radius);cursor:pointer;font-weight:700;box-shadow:0 10px 30px rgba(255,59,59,0.12);transition:transform .14s ease, box-shadow .14s;
  display:inline-flex;align-items:center;justify-content:center;gap:8px; text-decoration: none;
}
.btn:active{transform:translateY(1px)}
.btn.ghost{background:transparent;border:1px solid var(--glass-border);box-shadow:none;color:var(--text)}
.btn.small{padding:6px 8px;font-size:13px;border-radius:10px}

/* LAYOUT */
.main{display:grid;grid-template-columns:320px 1fr;gap:16px;margin-top:6px}
@media (max-width:980px){ .main{grid-template-columns:1fr} }

aside.sidebar{padding:14px;border-radius:var(--radius);background:var(--card);border:1px solid var(--glass-border);min-height:320px}
.nav{display:flex;flex-direction:column;gap:8px;margin-top:8px}
.nav button{display:flex;align-items:center;gap:10px;padding:10px;border-radius:10px;background:transparent;border:0;color:var(--muted);cursor:pointer;transition:all .18s; text-align: left;}
.nav button:hover{background:rgba(255,255,255,0.03);color:var(--text)}
.nav button.active{background:linear-gradient(90deg, rgba(255,59,59,0.08), rgba(255,59,59,0.03));color:var(--text);box-shadow:inset 0 1px 0 rgba(255,255,255,0.02);font-weight:700}
.search{margin-top:12px;display:flex;gap:8px}
.search input{flex:1;padding:10px;border-radius:10px;background:transparent;border:1px solid var(--glass-border);color:var(--text)}

/* Filters */
.role-wrap{margin-top:12px}
.role-wrap select{width:100%;margin-top:6px;padding:8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--text)}
.role-wrap select option {background:#111; color:white;}

/* CONTENT & GRID */
section.content{padding:14px;border-radius:var(--radius);background:var(--card);border:1px solid var(--glass-border);min-height:480px}
.grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
@media (max-width:680px){ .grid{grid-template-columns:1fr} }

/* PLAYER CARD */
.player{display:flex;align-items:center;padding:12px;border-radius:12px;background:linear-gradient(135deg, rgba(255,255,255,0.01), transparent);border:1px solid rgba(255,255,255,0.02);transition:transform .16s ease, box-shadow .16s ease;cursor:pointer;position:relative}
.player:hover{transform:translateY(-6px);box-shadow:0 18px 40px rgba(0,0,0,0.6)}
.avatar{width:64px;height:64px;border-radius:12px;display:grid;place-items:center;font-weight:700;font-size:20px;background:linear-gradient(135deg,#ffffff10,var(--accent));border:1px solid rgba(255,255,255,0.04);object-fit:cover;overflow:hidden;flex-shrink:0}
.avatar img{width:100%;height:100%;object-fit:cover;display:block}
.p-meta{flex:1;padding-left:12px;min-width:0}
.p-meta b{display:block;font-size:16px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.p-meta .muted{font-size:13px;color:var(--muted)}

/* MATCH TABLE */
.table-wrap{overflow:auto;border-radius:8px}
table{width:100%;border-collapse:collapse;font-size:14px}
th,td{padding:10px;text-align:left;border-bottom:1px solid rgba(255,255,255,0.03);color:var(--muted)}
th{font-weight:700;color:var(--muted);font-size:13px}
tr:hover td{background:linear-gradient(90deg, rgba(255,255,255,0.01), transparent)}

/* MODAL */
.modal-back{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(2,6,23,0.85);z-index:120;padding:20px;backdrop-filter:blur(4px)}
.modal{width:920px;max-width:100%;border-radius:14px;padding:20px;background:#131316;border:1px solid rgba(255,255,255,0.1);box-shadow:0 30px 90px rgba(0,0,0,0.9);max-height:85vh;overflow:auto;position:relative}
.modal .close-x{position:absolute;right:12px;top:12px;width:36px;height:36px;border-radius:8px;display:grid;place-items:center;cursor:pointer;background:transparent;border:1px solid rgba(255,255,255,0.04);z-index:10}
.modal .close-x:hover{background:rgba(255,255,255,0.02);color:white}

/* FORMS */
form.row{display:flex;gap:10px;flex-wrap:wrap}
input,select,textarea{padding:10px;border-radius:10px;background:rgba(0,0,0,0.3) !important;border:1px solid var(--glass-border) !important;color:var(--text) !important;min-width:0;width:100%}
select option { background: #111; }
.kv{font-weight:700;color:var(--muted);font-size:12px;text-transform:uppercase;margin-top:10px;display:block;margin-bottom:4px}
.event-row{display:flex;gap:8px;align-items:center;margin-bottom:8px;background:rgba(255,255,255,0.02);padding:6px;border-radius:8px}
.event-row input, .event-row select{padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);margin:0}
.logo-thumb{width:40px;height:40px;border-radius:6px;object-fit:cover;border:1px solid rgba(255,255,255,0.1);background:#000}

/* Optimized Inputs */
.ev-min {
    width: 80px !important;
    text-align: center;
    font-size: 18px !important;
    font-weight: bold;
    padding: 12px !important;
    background: rgba(255,255,255,0.05) !important;
    border: 1px solid var(--accent) !important;
    color: white !important;
    -moz-appearance: textfield;
}
.ev-min::-webkit-outer-spin-button, .ev-min::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }

/* TIMELINE (Chat Style) */
.timeline-container { display: flex; flex-direction: column; gap: 10px; margin-top: 10px; }
.timeline-row { display: flex; align-items: center; width: 100%; }
.timeline-row.left { justify-content: flex-start; }
.timeline-row.right { justify-content: flex-end; }
.timeline-event { 
    background: rgba(255,255,255,0.03); 
    border: 1px solid rgba(255,255,255,0.05); 
    padding: 8px 12px; 
    border-radius: 10px; 
    max-width: 60%;
    position: relative;
}
.timeline-row.left .timeline-event { border-left: 3px solid var(--accent); border-top-left-radius: 0; }
.timeline-row.right .timeline-event { border-right: 3px solid #4a90e2; border-top-right-radius: 0; text-align: right; }
.timeline-minute { font-size: 11px; color: var(--muted); font-weight: bold; margin-bottom: 2px; }

/* MATCH HISTORY LIST */
.match-history-item {
    background: rgba(255,255,255,0.02);
    border: 1px solid rgba(255,255,255,0.03);
    padding: 10px;
    border-radius: 10px;
    margin-bottom: 8px;
    cursor: pointer;
    transition: background 0.2s;
    display: flex; justify-content: space-between; align-items: center;
}
.match-history-item:hover { background: rgba(255,255,255,0.05); }

/* RANKINGS */
.rank-card{background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03);border-radius:12px;padding:12px}
.podium-item{display:flex;align-items:center;gap:10px;padding:8px;margin-bottom:4px;border-radius:8px;background:rgba(255,255,255,0.01)}
.podium-item.p-1{background:linear-gradient(90deg, rgba(255,215,0,0.1), transparent);border-left:3px solid gold}
.podium-item.p-2{background:linear-gradient(90deg, rgba(192,192,192,0.1), transparent);border-left:3px solid silver}
.podium-item.p-3{background:linear-gradient(90deg, rgba(205,127,50,0.1), transparent);border-left:3px solid #cd7f32}
.rank-avatar{width:36px;height:36px;border-radius:8px;object-fit:cover;background:#333}
.hidden-list{display:none}

/* UTILS */
.muted-small{font-size:12px;color:rgba(255,255,255,0.5)}
.hover-glow:hover{box-shadow:0 12px 40px rgba(255,59,59,0.12);transform:translateY(-4px)}
button:focus,input:focus{outline:2px solid var(--accent);outline-offset:1px}

@media(max-width:700px){
  .event-row{flex-wrap:wrap}
  .event-row input, .event-row select{width:100%}
  .ev-min{width:100% !important}
}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="app">
      <header class="appbar">
        <div id="leagueLogoWrap"></div>
        <div class="brand"><h1 id="leagueTitle">SALESIAN LEAGUE</h1></div>
      </header>

      <div class="main">
        <aside class="sidebar">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
            <div class="small-muted">Menu</div>
            <div class="muted-small">Pin: <span id="pinLabel">****</span></div>
          </div>
          <nav class="nav" id="nav">
            <button class="active" data-view="players" onclick="app.showView('players')">üë• Giocatori</button>
            <button data-view="matches" onclick="app.showView('matches')">‚öΩ Partite</button>
            <button data-view="calendar" onclick="app.showView('calendar')">üìÖ Calendario</button>
            <button data-view="rankings" onclick="app.showView('rankings')">üèÜ Classifiche</button>
            <button data-view="admin" onclick="app.showView('admin')">‚öôÔ∏è Admin</button>
          </nav>
          <div class="search">
            <input id="search" placeholder="Cerca..." oninput="app.renderPlayers(this.value)" />
          </div>
          <div class="role-wrap">
            <label class="kv">Filtra Ruolo</label>
            <select id="roleFilter" onchange="app.renderPlayers()"><option value="">Tutti</option></select>
          </div>
        </aside>

        <section class="content" id="mainContent">
          <!-- Players -->
          <div id="viewPlayers" class="view">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
              <div><h2 style="margin:0">Giocatori</h2><div class="muted-small">Rosa completa</div></div>
              <div style="display:flex;gap:10px;align-items:center">
                <div class="muted-small">Tot: <span id="totalPlayers">0</span></div>
                <button class="btn small" onclick="window.openAddPlayer()">+ Nuovo</button>
              </div>
            </div>
            <div class="grid" id="playersGrid"></div>
          </div>

          <!-- Matches -->
          <div id="viewMatches" class="view" style="display:none">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
              <div><h2 style="margin:0">Partite</h2><div class="muted-small">Risultati e Cronaca</div></div>
              <button class="btn small" onclick="window.openAddMatch()">+ Partita</button>
            </div>
            <div class="table-wrap">
              <table style="width:100%">
                <thead><tr><th>Data</th><th>Match</th><th>Risultato</th><th>Azioni</th></tr></thead>
                <tbody id="matchesTable"></tbody>
              </table>
            </div>
          </div>

          <!-- Calendar -->
          <div id="viewCalendar" class="view" style="display:none">
            <h2>Calendario</h2>
            <div id="calendarList"></div>
          </div>

          <!-- Rankings -->
          <div id="viewRankings" class="view" style="display:none">
            <h2 style="margin-bottom:4px">Classifiche</h2>
            <div class="muted-small" style="margin-bottom:16px">Top 3 in evidenza</div>
            <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(280px, 1fr));gap:12px">
              <div class="rank-card"><h3>‚öΩ Goal</h3><div id="rankGoals"></div></div>
              <div class="rank-card"><h3>üèÜ Partite Vinte</h3><div id="rankWins"></div></div>
              <div class="rank-card"><h3>‚≠ê MVP</h3><div id="rankMvps"></div></div>
            </div>
          </div>

          <!-- Admin -->
          <div id="viewAdmin" class="view" style="display:none"></div>
        </section>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div id="modal" class="modal-back">
    <div class="modal" id="modalContent"></div>
  </div>

<!-- FIREBASE SDK -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

  // --- CONFIGURAZIONE FIREBASE REALE ---
  const firebaseConfig = {
    apiKey: "AIzaSyAe8cq6R5XUMV_GyQakNjc5YAPl17DUyE4",
    authDomain: "salesian-league.firebaseapp.com",
    databaseURL: "https://salesian-league-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "salesian-league",
    storageBucket: "salesian-league.firebasestorage.app",
    messagingSenderId: "9508166370",
    appId: "1:9508166370:web:d49e96a8c1d08ff8a09cbb"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const dbRef = getDatabase(app);

  // Expose DB functions to window
  window.saveToCloud = function(data) {
    set(ref(dbRef, 'league_db'), data);
  };

  // Listener for Realtime Updates
  onValue(ref(dbRef, 'league_db'), (snapshot) => {
    const data = snapshot.val();
    if(data) {
      window.db = data;
      if(!window.db.players) window.db.players=[];
      if(!window.db.matches) window.db.matches=[];
      if(!window.db.meta) window.db.meta={ leagueTitle: 'LEGA', leagueLogo: '' };
      if(!window.db.admin) window.db.admin={ pin: '2209' };
      
      window.renderAll();
    } else {
      window.seed(); 
    }
  });
</script>

<script>
document.addEventListener('DOMContentLoaded', ()=>{

  // DEFAULT STATE
  window.db = {
    players: [], matches: [], meta: { leagueTitle: 'SALESIAN LEAGUE', leagueLogo: '' }, admin: { pin: '2209' }
  };
  let adminMode = false;
  let returnToPlayerId = null;

  // --- SEED (Solo se DB vuoto) ---
  window.seed = function(){
    const roles = ['Portiere','Difensore','Centrocampista','Attaccante'];
    const newPlayers = [];
    for(let i=1; i<=5; i++){
      newPlayers.push({
        id: 'p_'+Math.random().toString(36).substr(2,9),
        firstName: 'Nome'+i, lastName: 'Cognome'+i, 
        birthYear: 2000, position: roles[i%4], 
        ratings: {tec:6, fis:6, vel:6}, photo: ''
      });
    }
    window.db.players = newPlayers;
    window.saveToCloud(window.db); 
  }

  // --- UTILS ---
  const uid = () => Math.random().toString(36).substr(2,9);
  const escape = (s) => s ? String(s).replace(/[&<>"']/g, '') : '';
  const readFlo = (f) => new Promise(r => { 
     if(!f) r(null); 
     const rd=new FileReader(); 
     rd.onload=e=>r(e.target.result); 
     rd.readAsDataURL(f); 
  });

  // --- STATS LOGIC ---
  function getMatchScore(m){
    let s = [0,0];
    (m.events||[]).forEach(ev => {
      if(ev.type === 'goal' || ev.type === 'penalty'){
        if(typeof ev.teamIndex === 'number') s[ev.teamIndex]++;
      } else if (ev.type === 'own') {
        const otherTeam = ev.teamIndex === 0 ? 1 : 0;
        s[otherTeam]++;
      }
    });
    return s;
  }

  function getPlayerStats(pid){
    let goals=0, played=0, wins=0, mvps=0;
    
    window.db.matches.forEach(m => {
      let teamIdx = -1;
      m.formations.forEach((f, idx) => {
        if(f.players.some(p => p.playerId === pid)) {
          played++;
          teamIdx = idx;
        }
      });

      (m.events||[]).forEach(ev => {
        if(ev.playerId === pid && (ev.type === 'goal' || ev.type === 'penalty')) goals++;
      });

      if(m.mvpPlayerId === pid) mvps++;

      if(teamIdx !== -1) {
        const score = getMatchScore(m); 
        let winner = -1;
        if(score[0] > score[1]) winner = 0;
        else if(score[1] > score[0]) winner = 1;
        if(winner !== -1 && winner === teamIdx) wins++;
      }
    });

    let voteSum=0, voteCount=0;
    window.db.matches.forEach(m => {
      m.formations.forEach(f => {
        f.players.forEach(pl => {
          if(pl.playerId === pid && pl.rating) {
            voteSum += Number(pl.rating);
            voteCount++;
          }
        });
      });
    });

    return { goals, played, wins, mvps, avg: voteCount ? (voteSum/voteCount).toFixed(2) : '-' };
  }

  // --- RENDERERS ---
  
  function renderHeader(){
    document.getElementById('leagueTitle').textContent = window.db.meta.leagueTitle;
    const wrp = document.getElementById('leagueLogoWrap');
    if(window.db.meta.leagueLogo) wrp.innerHTML = `<div class="league-logo"><img src="${window.db.meta.leagueLogo}" style="width:100%;height:100%;object-fit:cover"></div>`;
    else wrp.innerHTML = `<div class="league-logo"><div style="font-size:30px;font-weight:800;color:white">${window.db.meta.leagueTitle.charAt(0)}</div></div>`;
  }

  window.renderPlayers = (filter='') => {
    const grid = document.getElementById('playersGrid');
    grid.innerHTML = '';
    const roleVal = document.getElementById('roleFilter').value;
    const searchVal = filter || document.getElementById('search').value;
    
    const roleSel = document.getElementById('roleFilter');
    if(roleSel.options.length===1) {
       const roles = [...new Set(window.db.players.map(p=>p.position).filter(Boolean))];
       roles.forEach(r => roleSel.innerHTML += `<option value="${r}">${r}</option>`);
    }

    const list = window.db.players.filter(p => {
      const full = (p.firstName+' '+p.lastName).toLowerCase();
      return full.includes(searchVal.toLowerCase()) && (!roleVal || p.position === roleVal);
    });
    
    document.getElementById('totalPlayers').textContent = list.length;
    list.sort((a,b)=> a.lastName.localeCompare(b.lastName));

    list.forEach(p => {
      const s = getPlayerStats(p.id);
      const el = document.createElement('div');
      el.className = 'player';
      const img = p.photo ? `<img src="${p.photo}">` : (p.firstName[0]+p.lastName[0]);
      
      const btns = adminMode 
        ? `<button class="btn ghost small" onclick="event.stopPropagation(); window.deletePlayer('${p.id}')" style="color:var(--accent);position:relative;z-index:10">‚úï</button>`
        : ``;

      el.innerHTML = `
        <div class="avatar">${p.photo ? img : img}</div>
        <div class="p-meta">
          <b>${escape(p.firstName)} ${escape(p.lastName)}</b>
          <div class="muted">${escape(p.position)} ‚Ä¢ Media: ${s.avg}</div>
          <div class="muted-small kv" style="margin-top:4px">Gol: ${s.goals} ‚Ä¢ Win: ${s.wins} ‚Ä¢ MVP: ${s.mvps}</div>
        </div>
        <div style="display:flex;flex-direction:column;gap:6px;margin-left:auto;align-items:flex-end">
          <button class="btn ghost small" onclick="window.viewPlayer('${p.id}')">üëÅÔ∏è</button>
          ${btns}
        </div>
      `;
      grid.appendChild(el);
    });
  }

  window.renderMatches = () => {
    const tb = document.getElementById('matchesTable');
    tb.innerHTML = '';
    const sorted = [...window.db.matches].sort((a,b)=>new Date(b.date)-new Date(a.date));
    
    if(sorted.length===0) tb.innerHTML = `<tr><td colspan="4" class="muted-small">Nessuna partita.</td></tr>`;

    sorted.forEach(m => {
      const score = getMatchScore(m);
      const row = document.createElement('tr');
      const l1 = m.formations[0].teamLogo ? `<img src="${m.formations[0].teamLogo}" class="logo-thumb" style="width:24px;height:24px;vertical-align:middle">` : '';
      const l2 = m.formations[1].teamLogo ? `<img src="${m.formations[1].teamLogo}" class="logo-thumb" style="width:24px;height:24px;vertical-align:middle">` : '';

      const editBtn = adminMode ? `<button class="btn ghost small" onclick="window.editMatch('${m.id}')">‚úèÔ∏è</button>` : '';

      row.innerHTML = `
        <td>${new Date(m.date).toLocaleDateString()}</td>
        <td>
           <div style="font-weight:bold">${escape(m.title)}</div>
           <div class="muted-small">${l1} ${escape(m.formations[0].teamName)} vs ${l2} ${escape(m.formations[1].teamName)}</div>
        </td>
        <td style="font-weight:bold;font-size:16px;color:var(--accent)">${score[0]} - ${score[1]}</td>
        <td>
          <button class="btn ghost small" onclick="window.viewMatch('${m.id}')">Cronaca</button>
          ${editBtn}
        </td>
      `;
      tb.appendChild(row);
    });
  }

  window.renderRankings = () => {
    const data = window.db.players.map(p => {
      const s = getPlayerStats(p.id);
      return { ...p, ...s };
    });

    const buildList = (containerId, sortFn, valFn, label) => {
      const div = document.getElementById(containerId);
      const sorted = [...data].sort(sortFn);
      let html = '';
      sorted.slice(0,3).forEach((p, i) => {
        const val = valFn(p);
        if(val === 0) return;
        const img = p.photo ? `<img src="${p.photo}" class="rank-avatar">` : `<div class="rank-avatar" style="display:grid;place-items:center;font-size:10px">${p.firstName[0]}</div>`;
        html += `<div class="podium-item p-${i+1}">
          <div style="font-weight:bold;width:20px">${i+1}.</div>
          ${img}
          <div style="flex:1;font-size:14px"><b>${escape(p.lastName)}</b> ${escape(p.firstName)}</div>
          <div style="font-weight:bold;color:var(--accent)">${val} ${label}</div>
        </div>`;
      });
      const rest = sorted.slice(3).filter(p => valFn(p) > 0);
      if(rest.length > 0) {
        const restId = containerId + '_rest';
        html += `<button class="btn ghost small" style="width:100%;margin-top:8px" onclick="document.getElementById('${restId}').style.display='block';this.style.display='none'">Mostra altri (${rest.length})</button>`;
        html += `<div id="${restId}" class="hidden-list" style="margin-top:8px">`;
        rest.forEach((p, i) => {
           html += `<div style="display:flex;justify-content:space-between;padding:6px;border-bottom:1px solid rgba(255,255,255,0.02);font-size:13px">
             <span>${i+4}. ${escape(p.lastName)} ${escape(p.firstName)}</span>
             <b>${valFn(p)}</b>
           </div>`;
        });
        html += `</div>`;
      } else if (html === '') {
        html = '<div class="muted-small">Nessun dato.</div>';
      }
      div.innerHTML = html;
    };

    buildList('rankGoals', (a,b)=>b.goals-a.goals, p=>p.goals, '');
    buildList('rankWins', (a,b)=>b.wins-a.wins, p=>p.wins, '');
    buildList('rankMvps', (a,b)=>b.mvps-a.mvps, p=>p.mvps, '');
  }

  window.renderCalendar = () => {
    const c = document.getElementById('calendarList');
    c.innerHTML = '';
    const sorted = [...window.db.matches].sort((a,b)=>new Date(a.date)-new Date(b.date));
    sorted.forEach(m => {
       const s = getMatchScore(m);
       const played = (m.events||[]).some(e=>['goal','penalty','own'].includes(e.type));
       c.innerHTML += `<div style="background:var(--card);padding:10px;border-radius:10px;margin-bottom:8px;border:1px solid var(--glass-border)">
         <div style="display:flex;justify-content:space-between">
            <b>${new Date(m.date).toLocaleDateString()}</b>
            <span>${played ? s.join('-') : 'Da giocare'}</span>
         </div>
         <div class="muted-small">${escape(m.title)}</div>
         <div style="margin-top:4px">${escape(m.formations[0].teamName)} vs ${escape(m.formations[1].teamName)}</div>
       </div>`;
    });
  }

  window.renderAdmin = () => {
    const div = document.getElementById('viewAdmin');
    if(!adminMode){
      div.innerHTML = `<div style="text-align:center;padding:40px">
        <h2>Area Admin</h2>
        <div style="max-width:300px;margin:20px auto;display:flex;gap:8px">
          <input type="password" id="adminPinInp" placeholder="PIN" style="text-align:center">
          <button class="btn" onclick="window.tryLogin()">Entra</button>
        </div>
      </div>`;
    } else {
      div.innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
           <h2>Pannello Admin</h2>
           <button class="btn ghost small" onclick="window.adminLogout()">Esci</button>
        </div>
        <div class="grid">
           <div class="rank-card">
              <h4>Gestione</h4>
              <button class="btn small" style="width:100%;margin-bottom:8px" onclick="window.openAddPlayer()">+ Giocatore</button>
              <button class="btn small" style="width:100%" onclick="window.openAddMatch()">+ Partita</button>
           </div>
           <div class="rank-card">
              <h4>Sistema</h4>
              <button class="btn ghost small" style="width:100%;margin-bottom:8px" onclick="window.editMeta()">Logo / Titolo</button>
              <button class="btn ghost small" style="width:100%" onclick="window.changePin()">Cambia PIN</button>
           </div>
        </div>
      `;
    }
  }

  // --- GLOBAL WINDOW ACTIONS ---

  window.tryLogin = () => {
    const v = document.getElementById('adminPinInp').value;
    if(v === window.db.admin.pin) { 
      adminMode = true; 
      document.getElementById('pinLabel').innerText = "(Admin)";
      window.renderAll(); 
    } else alert('Errato');
  }
  window.adminLogout = () => { 
    adminMode = false; 
    document.getElementById('pinLabel').innerText = "****"; 
    window.renderAll(); 
  }

  window.closeModal = () => {
      const modal = document.getElementById('modal');
      if(returnToPlayerId) {
          const pid = returnToPlayerId;
          returnToPlayerId = null;
          window.viewPlayer(pid);
      } else {
          modal.style.display='none';
          document.getElementById('modalContent').innerHTML = '';
      }
  };
  
  function openModal(html, backSupported=false){
      if(!backSupported) returnToPlayerId = null; 
      const m = document.getElementById('modalContent');
      m.innerHTML = html;
      document.getElementById('modal').style.display = 'flex';
  }

  window.editMeta = () => {
     openModal(`
       <div class="close-x" onclick="window.closeModal()">‚úï</div>
       <h3>Impostazioni Lega</h3>
       <form id="metaForm" class="row">
         <div style="width:100%"><label class="kv">Nome Lega</label><input name="tit" value="${escape(window.db.meta.leagueTitle)}" required></div>
         <div style="width:100%"><label class="kv">Logo Lega</label><input type="file" id="metaLogo"></div>
         <button class="btn" style="width:100%;margin-top:10px">Salva</button>
       </form>
     `);
     document.getElementById('metaForm').onsubmit = async (e) => {
        e.preventDefault();
        const t = e.target.tit.value;
        const f = document.getElementById('metaLogo').files[0];
        if(t) window.db.meta.leagueTitle = t;
        if(f) window.db.meta.leagueLogo = await readFlo(f);
        window.saveToCloud(window.db); 
        window.closeModal(); 
        window.renderAll();
     };
  }

  window.changePin = () => {
     const p = prompt("Inserisci il nuovo PIN:");
     if(p) { window.db.admin.pin = p; window.saveToCloud(window.db); alert("PIN Cambiato con successo!"); }
  }

  window.openAddPlayer = () => {
    if(!adminMode) return alert("Accedi come admin!");
    openModal(`
      <div class="close-x" onclick="window.closeModal()">‚úï</div>
      <h3>Nuovo Giocatore</h3>
      <form id="frmP" class="row">
        <input name="fn" placeholder="Nome" required>
        <input name="ln" placeholder="Cognome" required>
        <input name="by" type="number" placeholder="Anno (es. 2000)">
        <select name="pos">${['Portiere','Difensore','Centrocampista','Attaccante'].map(r=>`<option>${r}</option>`)}</select>
        <div style="width:100%"><label class="kv">Foto</label><input type="file" id="fp" accept="image/*"></div>
        <div class="kv" style="width:100%">Scheda Tecnica (0-10)</div>
        <input name="v1" type="number" placeholder="Tecnica">
        <input name="v2" type="number" placeholder="Fisico">
        <input name="v3" type="number" placeholder="Velocit√†">
        <button class="btn" style="width:100%;margin-top:10px">Salva</button>
      </form>
    `);
    document.getElementById('frmP').onsubmit = async(e)=>{
      e.preventDefault();
      const fd=new FormData(e.target);
      const photo = await readFlo(document.getElementById('fp').files[0]);
      window.db.players.push({
        id: 'p_'+uid(),
        firstName: fd.get('fn'), lastName: fd.get('ln'),
        birthYear: fd.get('by'), position: fd.get('pos'),
        ratings: {tec:fd.get('v1'), fis:fd.get('v2'), vel:fd.get('v3')},
        photo
      });
      window.saveToCloud(window.db); window.closeModal();
    };
  }

  window.viewPlayer = (pid) => {
    const p = window.db.players.find(x=>x.id===pid);
    const s = getPlayerStats(pid);
    const btns = adminMode ? 
      `<button class="btn small" onclick="window.editPlayer('${pid}')">Modifica</button>` : '';

    const history = window.db.matches.filter(m => 
        m.formations.some(f => f.players.some(pl => pl.playerId === pid))
    ).sort((a,b) => new Date(b.date) - new Date(a.date));

    const historyHTML = history.map(m => {
        const score = getMatchScore(m);
        // PASS TRUE to preserve context
        return `<div class="match-history-item" onclick="window.viewMatch('${m.id}', '${pid}')">
            <div style="display:flex;justify-content:space-between;width:100%">
                <div>
                    <div style="font-size:13px;font-weight:bold">${escape(m.title)}</div>
                    <div class="muted-small">${new Date(m.date).toLocaleDateString()}</div>
                </div>
                <div style="font-weight:bold;color:var(--accent);display:flex;align-items:center;gap:5px">
                    ${score[0]}-${score[1]} <button class="btn ghost small">üëÅÔ∏è</button>
                </div>
            </div>
        </div>`;
    }).join('');
    
    openModal(`
      <div class="close-x" onclick="window.closeModal()">‚úï</div>
      <div style="display:flex;gap:15px;align-items:center">
         ${p.photo ? `<img src="${p.photo}" style="width:80px;height:80px;border-radius:12px;object-fit:cover">` : `<div class="avatar" style="width:80px;height:80px;font-size:30px">${p.firstName[0]}</div>`}
         <div>
            <h2 style="margin:0">${escape(p.firstName)} ${escape(p.lastName)}</h2>
            <div class="muted">${escape(p.position)} ‚Ä¢ ${p.birthYear}</div>
         </div>
      </div>
      <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin:20px 0;text-align:center">
         <div class="rank-card"><b>${s.played}</b><br><span class="muted-small">Partite</span></div>
         <div class="rank-card"><b>${s.goals}</b><br><span class="muted-small">Gol</span></div>
         <div class="rank-card"><b>${s.wins}</b><br><span class="muted-small">Vinte</span></div>
         <div class="rank-card"><b>${s.mvps}</b><br><span class="muted-small">MVP</span></div>
      </div>
      <div class="kv">Scheda Tecnica</div>
      <div style="display:flex;gap:10px;margin-bottom:20px">
        <span class="chip">Tecnica: ${p.ratings.tec||'-'}</span>
        <span class="chip">Fisico: ${p.ratings.fis||'-'}</span>
        <span class="chip">Velocit√†: ${p.ratings.vel||'-'}</span>
      </div>
      
      <div class="kv">Storico Partite</div>
      <div style="max-height:200px;overflow-y:auto;margin-bottom:15px">
         ${historyHTML || '<div class="muted-small">Nessuna partita giocata.</div>'}
      </div>

      <div style="text-align:right">${btns}</div>
    `);
  }

  window.editPlayer = (pid) => {
    const p = window.db.players.find(x=>x.id===pid);
    openModal(`
      <div class="close-x" onclick="window.closeModal()">‚úï</div>
      <h3>Modifica</h3>
      <form id="efp" class="row">
        <input name="fn" value="${escape(p.firstName)}">
        <input name="ln" value="${escape(p.lastName)}">
        <input name="pos" value="${escape(p.position)}">
        <div style="width:100%"><label class="kv">Foto</label><input type="file" id="efpf"></div>
        <button class="btn" style="width:100%">Aggiorna</button>
      </form>
    `);
    document.getElementById('efp').onsubmit = async(e)=>{
      e.preventDefault();
      const fd = new FormData(e.target);
      p.firstName = fd.get('fn'); p.lastName = fd.get('ln'); p.position = fd.get('pos');
      const f = document.getElementById('efpf').files[0];
      if(f) p.photo = await readFlo(f);
      window.saveToCloud(window.db); window.closeModal();
    }
  }

  window.deletePlayer = (pid) => {
    if(!confirm("ELIMINARE? Questa azione √® irreversibile e rimuover√† il giocatore da tutte le partite!")) return;
    window.db.players = window.db.players.filter(x=>x.id!==pid);
    window.db.matches.forEach(m => {
        m.formations.forEach(f => { f.players = f.players.filter(pl => pl.playerId !== pid); });
        m.events = (m.events||[]).filter(ev => ev.playerId !== pid);
        if(m.mvpPlayerId === pid) m.mvpPlayerId = null;
    });
    window.saveToCloud(window.db); 
    document.getElementById('modal').style.display='none';
  }

  window.openAddMatch = () => {
    if(!adminMode) return alert("Accedi come admin!");
    const opts = window.db.players.map(p=>`<option value="${p.id}">${escape(p.lastName)} ${escape(p.firstName)}</option>`).join('');
    openModal(`
      <div class="close-x" onclick="window.closeModal()">‚úï</div>
      <h3>Crea Partita</h3>
      <form id="nmf">
        <div class="row">
           <input name="tit" placeholder="Titolo (es. 1¬∞ Giornata)" required>
           <input name="dat" type="date" required>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:15px">
           <div class="rank-card">
              <label class="kv">Squadra A</label>
              <input name="ta_n" value="Team A" placeholder="Nome">
              <input type="file" id="fa_logo" class="muted-small">
              <select id="selA" multiple style="height:100px;margin-top:5px">${opts}</select>
           </div>
           <div class="rank-card">
              <label class="kv">Squadra B</label>
              <input name="tb_n" value="Team B" placeholder="Nome">
              <input type="file" id="fb_logo" class="muted-small">
              <select id="selB" multiple style="height:100px;margin-top:5px">${opts}</select>
           </div>
        </div>
        <button class="btn" style="width:100%;margin-top:15px">Crea</button>
      </form>
    `);
    document.getElementById('nmf').onsubmit = async (e) => {
       e.preventDefault();
       const fd = new FormData(e.target);
       const lA = await readFlo(document.getElementById('fa_logo').files[0]);
       const lB = await readFlo(document.getElementById('fb_logo').files[0]);
       
       const getPls = (selId) => [...document.getElementById(selId).selectedOptions].map(o=>{
           const p = window.db.players.find(x=>x.id===o.value);
           return {playerId:o.value, rating:'', role: p ? p.position : ''};
       });
       
       window.db.matches.push({
         id: 'm_'+uid(),
         title: fd.get('tit'), date: fd.get('dat'),
         formations: [
           { teamName: fd.get('ta_n'), teamLogo: lA, players: getPls('selA') },
           { teamName: fd.get('tb_n'), teamLogo: lB, players: getPls('selB') }
         ],
         events: [],
         mvpPlayerId: null
       });
       window.saveToCloud(window.db); window.closeModal();
    };
  }

  // VIEW MATCH
  window.viewMatch = (mid, fromPid = null) => {
    if(fromPid) returnToPlayerId = fromPid; 

    const m = window.db.matches.find(x=>x.id===mid);
    const score = getMatchScore(m);
    
    // Timeline
    const eventsSorted = (m.events||[]).sort((a,b)=>a.minute-b.minute);
    let timelineHTML = `<div class="timeline-container">`;
    
    if(eventsSorted.length === 0) timelineHTML += `<div class="muted-small" style="text-align:center">Nessun evento</div>`;

    eventsSorted.forEach(ev => {
       const p = window.db.players.find(x=>x.id===ev.playerId);
       const name = p ? p.lastName : '?';
       const sideClass = ev.teamIndex === 0 ? 'left' : 'right';
       
       let label = ev.type.toUpperCase();
       let color = 'white';
       if(ev.type==='goal'||ev.type==='penalty') color='var(--accent)';
       else if(ev.type==='red') color='red';
       else if(ev.type==='own') { color='orange'; label='AUTOGOL'; }

       timelineHTML += `
         <div class="timeline-row ${sideClass}">
            <div class="timeline-event">
               <div class="timeline-minute">${ev.minute}'</div>
               <div style="font-weight:bold;color:${color}">${label}</div>
               <div style="font-size:13px">${escape(name)}</div>
            </div>
         </div>
       `;
    });
    timelineHTML += `</div>`;

    let mvpShow = '';
    if(m.mvpPlayerId){
       const mvpP = window.db.players.find(x=>x.id===m.mvpPlayerId);
       if(mvpP) mvpShow = `<div class="rank-card" style="margin-top:10px;text-align:center;border-color:gold">‚≠ê MVP: <b>${mvpP.firstName} ${mvpP.lastName}</b></div>`;
    }

    const renderTeam = (idx) => {
      const f = m.formations[idx];
      return `<div>
        <div style="font-weight:bold;border-bottom:1px solid var(--glass-border);padding-bottom:5px;margin-bottom:5px">${f.teamLogo?`<img src="${f.teamLogo}" class="logo-thumb" style="vertical-align:middle;margin-right:5px">`:''}${escape(f.teamName)}</div>
        ${f.players.map(pl=>{
           const ply = window.db.players.find(x=>x.id===pl.playerId);
           // Role Logic: Prefer match specific role, fallback to player profile role
           const roleDisplay = pl.role || (ply ? ply.position : '');
           return `<div style="font-size:13px;display:flex;justify-content:space-between;padding:3px 0">
             <span>${ply?ply.lastName:''}</span>
             <span>${roleDisplay?`<span class="muted-small">${roleDisplay}</span>`:''} <b style="color:${pl.rating>=6?'lightgreen':'#ff6b6b'}">${pl.rating||'-'}</b></span>
           </div>`;
        }).join('')}
      </div>`;
    };

    openModal(`
      <div class="close-x" onclick="window.closeModal()">‚úï</div>
      <div style="text-align:center">
         <div class="muted-small">${new Date(m.date).toLocaleDateString()}</div>
         <h3>${escape(m.title)}</h3>
         <div style="font-size:36px;font-weight:800;color:var(--accent);margin:10px 0">${score[0]} - ${score[1]}</div>
      </div>
      ${mvpShow}
      <div class="grid" style="margin-top:20px">
         ${renderTeam(0)}
         ${renderTeam(1)}
      </div>
      <h4 style="border-bottom:1px solid var(--glass-border);padding-bottom:5px;margin-top:20px">Cronaca</h4>
      ${timelineHTML}
    `, true);
  }

  window.editMatch = (mid) => {
    const m = window.db.matches.find(x=>x.id===mid);
    
    const allPlayersInMatch = [...m.formations[0].players, ...m.formations[1].players];
    const getPOpts = (selId) => allPlayersInMatch.map(pl => {
       const p = window.db.players.find(x=>x.id===pl.playerId);
       if(!p) return '';
       return `<option value="${p.id}" ${selId===p.id?'selected':''}>${p.lastName} ${p.firstName}</option>`;
    }).join('');

    const evRows = (m.events||[]).map((ev, i) => `
      <div class="event-row">
         <input type="number" class="ev-min" value="${ev.minute}" placeholder="Min" inputmode="numeric">
         <select class="ev-type">
            <option value="goal" ${ev.type==='goal'?'selected':''}>Goal</option>
            <option value="penalty" ${ev.type==='penalty'?'selected':''}>Rigore</option>
            <option value="own" ${ev.type==='own'?'selected':''}>Autogol</option>
            <option value="red" ${ev.type==='red'?'selected':''}>Rosso</option>
         </select>
         <select class="ev-team">
            <option value="0" ${ev.teamIndex==0?'selected':''}>${m.formations[0].teamName}</option>
            <option value="1" ${ev.teamIndex==1?'selected':''}>${m.formations[1].teamName}</option>
         </select>
         <select class="ev-pl">${getPOpts(ev.playerId)}</select>
         <button class="btn ghost small" onclick="this.parentElement.remove()">X</button>
      </div>
    `).join('');

    const renderTeamInputs = (idx) => {
       return m.formations[idx].players.map((pl, pi) => {
          const p = window.db.players.find(x=>x.id===pl.playerId);
          return `<div style="display:flex;gap:5px;margin-bottom:4px;align-items:center">
             <div style="width:100px;font-size:12px;overflow:hidden;text-overflow:ellipsis">${p.lastName}</div>
             <input value="${pl.role||''}" placeholder="Ruolo" id="role_${idx}_${pi}" style="padding:4px !important">
             <input type="number" value="${pl.rating||''}" placeholder="Voto" id="rate_${idx}_${pi}" style="padding:4px !important;width:60px">
          </div>`;
       }).join('');
    }

    openModal(`
      <div class="close-x" onclick="window.closeModal()">‚úï</div>
      <h3>Modifica Partita</h3>
      <div class="grid">
        <div>
           <label class="kv">${m.formations[0].teamName} (Logo/Nome)</label>
           <input id="en_tA" value="${m.formations[0].teamName}">
           <input type="file" id="el_tA">
           <div style="margin-top:10px;max-height:200px;overflow:auto">${renderTeamInputs(0)}</div>
        </div>
        <div>
           <label class="kv">${m.formations[1].teamName} (Logo/Nome)</label>
           <input id="en_tB" value="${m.formations[1].teamName}">
           <input type="file" id="el_tB">
           <div style="margin-top:10px;max-height:200px;overflow:auto">${renderTeamInputs(1)}</div>
        </div>
      </div>
      
      <div style="margin-top:20px;border-top:1px solid var(--glass-border);padding-top:10px">
         <label class="kv">MVP Unico</label>
         <select id="mvpSel" style="background:#222"><option value="">-- Nessuno --</option>${getPOpts(m.mvpPlayerId)}</select>
      </div>

      <div style="margin-top:20px;border-top:1px solid var(--glass-border);padding-top:10px">
         <div style="display:flex;justify-content:space-between">
            <label class="kv">Cronaca (Eventi)</label>
            <button class="btn small" onclick="window.addEvRow('${m.id}')">+ Evento</button>
         </div>
         <div id="evList">${evRows}</div>
      </div>

      <div style="margin-top:20px;display:flex;justify-content:space-between">
         <button class="btn ghost" onclick="window.deleteMatch('${mid}')" style="color:var(--accent)">Elimina Partita</button>
         <button class="btn" onclick="window.saveMatchEdits('${mid}')">Salva Modifiche</button>
      </div>
    `);
  }
  
  window.addEvRow = (mid) => {
       const m = window.db.matches.find(x=>x.id===mid);
       const allPlayersInMatch = [...m.formations[0].players, ...m.formations[1].players];
       const opts = allPlayersInMatch.map(pl => {
         const p = window.db.players.find(x=>x.id===pl.playerId);
         return `<option value="${p.id}">${p.lastName} ${p.firstName}</option>`;
       }).join('');

       const div = document.createElement('div');
       div.className = 'event-row';
       div.innerHTML = `
         <input type="number" class="ev-min" placeholder="Min" inputmode="numeric">
         <select class="ev-type"><option value="goal">Goal</option><option value="penalty">Rigore</option><option value="own">Autogol</option><option value="red">Rosso</option></select>
         <select class="ev-team"><option value="0">${m.formations[0].teamName}</option><option value="1">${m.formations[1].teamName}</option></select>
         <select class="ev-pl">${opts}</select>
         <button class="btn ghost small" onclick="this.parentElement.remove()">X</button>
       `;
       document.getElementById('evList').appendChild(div);
  }

  window.saveMatchEdits = async (mid) => {
       const m = window.db.matches.find(x=>x.id===mid);
       
       const nA = document.getElementById('en_tA').value;
       const nB = document.getElementById('en_tB').value;
       const fA = document.getElementById('el_tA').files[0];
       const fB = document.getElementById('el_tB').files[0];
       if(nA) m.formations[0].teamName = nA;
       if(nB) m.formations[1].teamName = nB;
       if(fA) m.formations[0].teamLogo = await readFlo(fA);
       if(fB) m.formations[1].teamLogo = await readFlo(fB);

       m.formations.forEach((f, idx) => {
          f.players.forEach((pl, pi) => {
             const r = document.getElementById(`rate_${idx}_${pi}`).value;
             const ro = document.getElementById(`role_${idx}_${pi}`).value;
             pl.rating = r;
             pl.role = ro; 
          });
       });

       m.mvpPlayerId = document.getElementById('mvpSel').value || null;

       const rows = document.querySelectorAll('.event-row');
       m.events = Array.from(rows).map(r => ({
          minute: r.querySelector('.ev-min').value,
          type: r.querySelector('.ev-type').value,
          teamIndex: Number(r.querySelector('.ev-team').value),
          playerId: r.querySelector('.ev-pl').value
       }));

       window.saveToCloud(window.db); window.closeModal();
  };

  window.deleteMatch = (mid) => {
       if(!confirm("Sicuro di voler eliminare questa partita definitivamente?")) return;
       window.db.matches = window.db.matches.filter(x=>x.id!==mid);
       window.saveToCloud(window.db); 
       document.getElementById('modal').style.display='none';
  }

  window.app = { showView: (v) => {
       document.querySelectorAll('.nav button').forEach(b=>b.classList.remove('active'));
       document.querySelector(`[data-view="${v}"]`).classList.add('active');
       document.querySelectorAll('.view').forEach(e=>e.style.display='none');
       document.getElementById('view'+v.charAt(0).toUpperCase()+v.slice(1)).style.display='block';
       if(v==='rankings') window.renderRankings();
  }, renderPlayers: window.renderPlayers };

  // --- INIT UI ---
  window.renderAll = function(){
    renderHeader();
    window.renderPlayers();
    window.renderMatches();
    window.renderCalendar();
    window.renderRankings();
    window.renderAdmin();
  }

});
</script>
</body>
</html>